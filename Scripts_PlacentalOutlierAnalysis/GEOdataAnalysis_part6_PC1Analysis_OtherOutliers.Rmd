---
title: "PC1Analysis_use residulas"
author: "Qianhui"
date: "12/17/2018"
output: html_document
---

This document is mainly for part6 of the GEO data set analysis, that is pull out PC1 probes.


```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.align = "center", error = TRUE, echo = TRUE) # fig.width = 7, 
```


# 1. load data and packages
```{r package, warning=FALSE, message=FALSE}
library(tidyverse)
library(readxl)
library(minfi)
library(magrittr)
library(tibble)
library(data.table)
library(limma)
library(ewastools)
library(ENmix)
library(wateRmelon)
library(WGCNA)
library(impute)
library(missMethyl)
library(FactoMineR)
library(doParallel)
library(ggplot2)
library(gridExtra)
library(ggpubr)
library(RColorBrewer)
pal <- brewer.pal(8, "Dark2")
# GEOmeta, GEO_phenotypes
load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_phenotypes_add10.RData")

# Join.df_v2, GEO_phenotypes_joinedSamples, MDS_joinedSamples
load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_joinedSamples551_Beta_MDS.RData")

# # PCA_Placenta_M, PCA_PlacentaT1_M, PCA_PlacentaTerm_M
load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/PCA_placenta_deciduals_allT1Term_BMval.RData")

# annotation needed for using functions
ann450k <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/ann450k_GEO15sets.rds")
annEPIC <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/annEPIC_GEO15sets.rds")

# BM list after normalisation, but not corrected for batch across samples
NormBMlist <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/NormBMlist.rds")

CutOffRight <- quantile(PCA_Placenta_M$ind$coord[, 1], 0.75)+ 1.5*IQR(PCA_Placenta_M$ind$coord[, 1])
CutOffLeft <- quantile(PCA_Placenta_M$ind$coord[, 1], 0.25)- 1.5*IQR(PCA_Placenta_M$ind$coord[, 1])

CutOffRightNames <- PCA_Placenta_M$ind$coord[, 1][PCA_Placenta_M$ind$coord[, 1]>CutOffRight] %>% sort() %>% names
CutOffLeftNames <- PCA_Placenta_M$ind$coord[, 1][PCA_Placenta_M$ind$coord[, 1]<CutOffLeft] %>% sort()%>% names

# M values and matched phenodata
registerDoParallel(cores=5)

Residuals <- NormBMlist$NormMAll
table(colnames(Residuals) %in% GEO_phenotypes$Sample_name)

Matched_pd <- GEO_phenotypes[match(colnames(Residuals), GEO_phenotypes$Sample_name),]

phenoDataPlacenta <- readRDS(file = "/home/qianhui/DNAme/Process_placenta_workflow/phenoDataPlacenta.rds")
#GEO_RGset_EPIC_normalPlacenta_ourStudy, GEO_phenoData_EPIC_normalPlacenta_ourStudy
load(file ="/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_RG&pData_normalPlacenta.RData")

MetadataOurSamples <- phenoDataPlacenta[rownames(phenoDataPlacenta)%in%GEO_phenoData_EPIC_normalPlacenta_ourStudy$Sample_name, ]

```


# the contribution of probes to PC1 (all samples including different tissue types)
## GO analysis for top 2% probes in PC1
```{r ContributionT2Samples}
# contribution of probs in Dim1
ProbeContrib.df <- PCA_Placenta_M$var$contrib %>% as.data.frame() %>% 
  rownames_to_column(var="Name")
###### quick look at conribution percentages:
summary(ProbeContrib.df)
###### get Dim1 top 2% probes by ordering the contribution percentages of Dim1
ProbeContrib.df.orderedTop2perc <- ProbeContrib.df[base::order(-ProbeContrib.df$Dim.1),] %>% 
   dplyr::slice(1:(0.02*nrow(ProbeContrib.df)))
# saveRDS(ProbeContrib.df_T2, 
#         file ="/home/qianhui/DNAme/Process_decidual/RDSfiles/Placenta_ProbeContrib.df_T2_residual.rds")
# saveRDS(ProbeContrib.df.orderedTop2perc_T2, 
#         file ="/home/qianhui/DNAme/Process_decidual/RDSfiles/Placenta_Dim1_top2perc_forOutlierAnalysis_T2_residual.rds")

# GO analysis
Dim1_top2perc <- ProbeContrib.df.orderedTop2perc$Name
goMeth_Dim1_top2perc <- gometh(sig.cpg = Dim1_top2perc,
                           all.cpg = rownames(Residuals),
                           collection = "GO", array.type = "450K", prior.prob = TRUE, ann=ann450k)
goMeth_Dim1_top2perc[goMeth_Dim1_top2perc$FDR<0.05,] %>% dim()
topGO(goMeth_Dim1_top2perc, number = 10)

# plot GO terms
top2perc_GO <- topGO(goMeth_Dim1_top2perc, number = 20) %>% rownames_to_column(var="GO_ID") %>% arrange(FDR)

top2perc_GO$Terms <- factor(top2perc_GO$Term, levels = unique(rev(top2perc_GO$Term)))

theme_set(theme_pubr())

top2perc_GOPlot <- ggplot(top2perc_GO, aes(x= Terms, y= -log10(FDR))) + #,fill=Ont
  geom_bar(stat='identity', position=position_dodge())+ #"midnightblue"
  scale_fill_hue()+
  coord_flip()+
  geom_hline(yintercept = -log10(0.05), colour="red")+
  labs(x="", y="-log10(FDR)")+ #,fill="GO categories"
  scale_y_continuous(breaks = c(0, 10, 20))+
  theme(axis.text.y = element_text(size=9, colour ="black"),
        axis.text.x = element_text(size=8, colour ="black"),
        axis.title=element_text(size=9, colour ="black"),#,face="bold"
        text = element_text(size=9, colour ="black"))

top2perc_GOPlot
saveRDS(top2perc_GOPlot, file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/top2perc_GOPlot.rds")

```

# T1 placenta 
```{r T1}

PhenodataPlacenta_T1 <- Matched_pd[Matched_pd$Sample%in%"Placenta" & Matched_pd$Trimester%in%"First",]

Placenta_Mnorm_v1_T1 <-  Residuals[,colnames(Residuals)%in%PhenodataPlacenta_T1$Sample_name]
Placenta_betaNorm_T1 <- 2^Placenta_Mnorm_v1_T1 / (1+2^Placenta_Mnorm_v1_T1)

```


# T1 outlier and pure samples 
```{r}
## plot box plot for beta values of Dim1_top2perc porbes
## manipulate data frames #"GSM1702177_7970368142_R05C02"
PhenodataPlacenta_T1$Sample_name[match(CutOffRightNames, PhenodataPlacenta_T1$Sample_name)]

OutlierT1 <- tibble(Outlier_T1Names = CutOffRightNames[CutOffRightNames%in%PhenodataPlacenta_T1$Sample_name],
                    Outlier_T1 = paste0("Outlier_T1_", 1:5))

PhenodataPlacenta_T1_addOutlier <- PhenodataPlacenta_T1 %>% left_join(OutlierT1, by=c("Sample_name"="Outlier_T1Names"))

PhenodataPlacenta_T1_addOutlier$Outlier_T1[is.na(PhenodataPlacenta_T1_addOutlier$Outlier_T1)] <- "Pure"

# PhenodataPlacenta_T2$OutlierMore <- factor(
#   ifelse(PhenodataPlacenta_T2$Additional_Info%in%"Outlier", "ImpureOutlier",
#          ifelse(PhenodataPlacenta_T2$Sample_name%in%CutOffRightNames, "PureOutlierRight", 
#                 ifelse(PhenodataPlacenta_T2$Sample_name%in%CutOffLeftNames, "PureOutlierLeft", "PurePlacenta"))))

#c("GSM1702177_7970368142_R05C02", "GSM1947213_6008581028_R01C01")

phenoDataPlacenta.df_T1 <- PhenodataPlacenta_T1_addOutlier %>% as.data.frame(stringsAsFactors=FALSE) %>%
  dplyr::select(c("Sample_name", "Outlier_T1"))

placenta_beta_dim1Top2perc_T1 <- Placenta_betaNorm_T1[rownames(Placenta_betaNorm_T1)%in%Dim1_top2perc,]
placenta_beta_dim1Top2perc.df_T1 <- placenta_beta_dim1Top2perc_T1 %>% 
  as.data.frame() %>% rownames_to_column(var="Name") %>% melt(id.var="Name") %>% 
  `colnames<-`(c("Name", "Sample_name", "value")) %>% 
  left_join(phenoDataPlacenta.df_T1, by="Sample_name")

outlierDim1Plot_T1 <- placenta_beta_dim1Top2perc.df_T1 %>% 
  ggplot(aes(x=Outlier_T1, y=value))+
  geom_boxplot()+
  # scale_x_discrete(labels=c("Outlier"="Outliers", "Standard"="Other Samples"))+
  labs(x="", y="Beta values")+
  # stat_compare_means(label = "p.signif", method = "t.test",
  #                    ref.group = ".all.") +
  theme(axis.text.y = element_text(size=12, colour ="black"),
        axis.text.x = element_text(size=12, colour ="black"),
        axis.title=element_text(size=12, colour ="black"),#,face="bold"
        text = element_text(size=12, colour ="black"))

outlierDim1Plot_T1

tiff(file = "/home/qianhui/DNAme/Process_decidual/figures/Placenta_Dim1top2percProbePlot_ForOutlier_T1.tiff",
     width = 20, height = 12, units = "cm", res = 300)
theme_set(theme_bw())
outlierDim1Plot_T1
dev.off()

# quantile(PCA_Placenta_M_T2$ind$coord[, 1], 0.75)+ 1.5*IQR(PCA_Placenta_M_T2$ind$coord[, 1])
# quantile(PCA_Placenta_M_T2$ind$coord[, 1], 0.25)- 1.5*IQR(PCA_Placenta_M_T2$ind$coord[, 1])

saveRDS(placenta_beta_dim1Top2perc.df_T1, file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/placenta_beta_dim1Top2perc.df_T1.rds")

```



# T2 placenta, and pot beta values for outliers and pure samples
```{r T2}

PhenodataPlacenta_T2 <- Matched_pd[Matched_pd$Sample%in%"Placenta" & Matched_pd$Trimester%in%"Second",]

Placenta_Mnorm_v1_T2 <-  Residuals[,colnames(Residuals)%in%PhenodataPlacenta_T2$Sample_name]
Placenta_betaNorm_T2 <- 2^Placenta_Mnorm_v1_T2 / (1+2^Placenta_Mnorm_v1_T2)

```

# T2 outlier and pure samples 
```{r}
## plot box plot for beta values of Dim1_top2perc porbes
## manipulate data frames #"GSM1702177_7970368142_R05C02"
PhenodataPlacenta_T2$Outlier <- factor(ifelse(PhenodataPlacenta_T2$Sample_name%in%CutOffRightNames, 
                                              "Outlier_T2_1", "Pure"))


phenoDataPlacenta.df_T2 <- PhenodataPlacenta_T2 %>% as.data.frame(stringsAsFactors=FALSE) %>%
  dplyr::select(c("Sample_name", "Outlier"))

placenta_beta_dim1Top2perc_T2 <- Placenta_betaNorm_T2[rownames(Placenta_betaNorm_T2)%in%Dim1_top2perc,]
placenta_beta_dim1Top2perc.df_T2 <- placenta_beta_dim1Top2perc_T2 %>% 
  as.data.frame() %>% rownames_to_column(var="Name") %>% melt(id.var="Name") %>% 
  `colnames<-`(c("Name", "Sample_name", "value")) %>% 
  left_join(phenoDataPlacenta.df_T2, by="Sample_name")

outlierDim1Plot_T2 <- placenta_beta_dim1Top2perc.df_T2 %>% 
  ggplot(aes(x=Outlier, y=value))+
  geom_boxplot()+
  # scale_x_discrete(labels=c("Outlier"="Outliers", "Standard"="Other Samples"))+
  labs(x="", y="Beta values")+
  # stat_compare_means(label = "p.signif", method = "t.test",
  #                    ref.group = ".all.") +
  theme(axis.text.y = element_text(size=12, colour ="black"),
        axis.text.x = element_text(size=12, colour ="black"),
        axis.title=element_text(size=12, colour ="black"),#,face="bold"
        text = element_text(size=12, colour ="black"))

outlierDim1Plot_T2

tiff(file = "/home/qianhui/DNAme/Process_decidual/figures/Placenta_Dim1top2percProbePlot_ForOutlier_T2_residual.tiff",
     width = 20, height = 12, units = "cm", res = 300)
theme_set(theme_bw())
outlierDim1Plot_T2
dev.off()

# quantile(PCA_Placenta_M_T2$ind$coord[, 1], 0.75)+ 1.5*IQR(PCA_Placenta_M_T2$ind$coord[, 1])
# quantile(PCA_Placenta_M_T2$ind$coord[, 1], 0.25)- 1.5*IQR(PCA_Placenta_M_T2$ind$coord[, 1])

saveRDS(placenta_beta_dim1Top2perc.df_T2, file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/placenta_beta_dim1Top2perc.df_T2.rds")

```

* The results showed that this one outlier from second trimester could be an impure placenta sample.



# Term placenta 
```{r T1}

PhenodataPlacenta_Term <- Matched_pd[Matched_pd$Sample%in%"Placenta" & Matched_pd$Trimester%in%"Term",]

Placenta_Mnorm_v1_Term <-  Residuals[,colnames(Residuals)%in%PhenodataPlacenta_Term$Sample_name]
Placenta_betaNorm_Term <- 2^Placenta_Mnorm_v1_Term / (1+2^Placenta_Mnorm_v1_Term)

```



# Term outlier and pure samples 
```{r}
## plot box plot for beta values of Dim1_top2perc porbes
## manipulate data frames #"GSM1702177_7970368142_R05C02"

OutlierTerm <- tibble(
  Outlier_TermNames = CutOffRightNames[CutOffRightNames%in%PhenodataPlacenta_Term$Sample_name],
  Outlier_Term = paste0("Outlier_Term_", 1:5))

PhenodataPlacenta_Term_addOutlier <- PhenodataPlacenta_Term %>% left_join(OutlierTerm, by=c("Sample_name"="Outlier_TermNames"))

PhenodataPlacenta_Term_addOutlier$Outlier_Term[is.na(PhenodataPlacenta_Term_addOutlier$Outlier_Term)] <- "Pure"

# make df for plotting
phenoDataPlacenta.df_Term <- PhenodataPlacenta_Term_addOutlier %>% as.data.frame(stringsAsFactors=FALSE) %>%
  dplyr::select(c("Sample_name", "Outlier_Term"))

placenta_beta_dim1Top2perc_Term <- Placenta_betaNorm_Term[rownames(Placenta_betaNorm_Term)%in%Dim1_top2perc,]

placenta_beta_dim1Top2perc.df_Term <- placenta_beta_dim1Top2perc_Term %>% 
  as.data.frame() %>% rownames_to_column(var="Name") %>% melt(id.var="Name") %>% 
  `colnames<-`(c("Name", "Sample_name", "value")) %>% 
  left_join(phenoDataPlacenta.df_Term, by="Sample_name")

outlierDim1Plot_Term <- placenta_beta_dim1Top2perc.df_Term %>% 
  ggplot(aes(x=Outlier_Term, y=value))+
  geom_boxplot()+
  # scale_x_discrete(labels=c("Outlier"="Outliers", "Standard"="Other Samples"))+
  labs(x="", y="Beta values")+
  # stat_compare_means(label = "p.signif", method = "t.test",
  #                    ref.group = ".all.") +
  theme(axis.text.y = element_text(size=12, colour ="black"),
        axis.text.x = element_text(size=12, colour ="black"),
        axis.title=element_text(size=12, colour ="black"),#,face="bold"
        text = element_text(size=12, colour ="black"))

outlierDim1Plot_Term

tiff(file = "/home/qianhui/DNAme/Process_decidual/figures/Placenta_Dim1top2percProbePlot_ForOutlierTerm.tiff",
     width = 20, height = 12, units = "cm", res = 300)
theme_set(theme_bw())
outlierDim1Plot_Term
dev.off()

# quantile(PCA_Placenta_M_T2$ind$coord[, 1], 0.75)+ 1.5*IQR(PCA_Placenta_M_T2$ind$coord[, 1])
# quantile(PCA_Placenta_M_T2$ind$coord[, 1], 0.25)- 1.5*IQR(PCA_Placenta_M_T2$ind$coord[, 1])

saveRDS(placenta_beta_dim1Top2perc.df_Term, file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/placenta_beta_dim1Top2perc.df_Term.rds")

```



# arrange plots

## combine top 2% boxplot to 1 plot
```{r}
#placenta_beta_dim1Top2perc.df_T1
# placenta_beta_dim1Top2perc.df <- placenta_beta_dim1Top2perc.df %>% dplyr::select(-OutlierAdd2)
colnames(placenta_beta_dim1Top2perc.df_T1)[4] <- "Outlier"
colnames(placenta_beta_dim1Top2perc.df_T2)[4] <- "Outlier"
colnames(placenta_beta_dim1Top2perc.df_Term)[4] <- "Outlier"

placenta_beta_dim1Top2perc.df_T1$Trimester <- rep("First", nrow(placenta_beta_dim1Top2perc.df_T1))

placenta_beta_dim1Top2perc.df_T2$Trimester <- rep("Second", nrow(placenta_beta_dim1Top2perc.df_T2))

placenta_beta_dim1Top2perc.df_Term$Trimester <- rep("Term", nrow(placenta_beta_dim1Top2perc.df_Term))

placenta_beta_dim1Top2perc.df_all <- rbind(placenta_beta_dim1Top2perc.df_T1, 
                                           placenta_beta_dim1Top2perc.df_T2,
                                           placenta_beta_dim1Top2perc.df_Term)

placenta_beta_dim1Top2perc.df_all$OutlierColor <- str_replace_all(placenta_beta_dim1Top2perc.df_all$Outlier,
                                                                  "Outlier.+", "Outlier")

# placenta_beta_dim1Top2perc.df_T1Term <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/placenta_beta_dim1Top2perc.df_T1Term.rds")
placenta_beta_dim1Top2perc.df_all <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/placenta_beta_dim1Top2perc.df_all,rds")

theme_set(theme_pubr())

outlierDim1Plot_all <- placenta_beta_dim1Top2perc.df_all %>% 
  ggplot(aes(x=as.factor(Outlier), y=value, fill=OutlierColor))+ 
  geom_violin(trim = T)+
  geom_boxplot(width=0.1, fill="white")+
  scale_fill_manual(name="Placenta", 
                    values = c("Outlier"="#1B9E77", "Pure"="#D95F02"),
                    labels = c("Outlier"="Mixed", "Pure"="Pure"))+
  # scale_x_discrete(labels="")+
  labs(x="", y="Beta values")+ #, fill="Placenta"
  facet_wrap(~Trimester, scale="free_x", nrow = 2)+
  # facet_grid(.~Trimester, scale="free_x")+
  guides(fill=guide_legend(nrow = 1)) +
  theme(axis.text.y = element_text(size=9, colour ="black"),
        axis.text.x = element_text(size=9, colour ="black"),
        # axis.ticks.x= element_blank(),
        axis.title=element_text(size=9, colour ="black"),#,face="bold"
        strip.text.x = element_text(size = 9, colour = "black"),
        text = element_text(size=9, colour ="black"),
        legend.position="top")

# convert ggplot object to grob object
gp <- ggplotGrob(outlierDim1Plot_all)

# optional: take a look at the grob object's layout
gtable::gtable_show_layout(gp)

# get gtable columns corresponding to the facets (5 & 9, in this case)
facet.columns <- gp$layout$l[grepl("panel", gp$layout$name)]

# get the number of unique x-axis values per facet (1 & 3, in this case)
x.var <- sapply(ggplot_build(outlierDim1Plot_all)$layout$panel_scales_x,
                function(l) length(l$range$range))

# change the relative widths of the facet columns based on
# how many unique x-axis values are in each facet
gp$widths[facet.columns] <- gp$widths[facet.columns] * c(2,6,2)

# plot result
grid::grid.draw(gp)

saveRDS(gp, file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/outlierDim1Plot_all.rds")
# saveRDS(placenta_beta_dim1Top2perc.df_all, file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/placenta_beta_dim1Top2perc.df_all,rds")

```


# Figure1
```{r}
theme_set(theme_pubr())

# PCAs
# PCA_Placenta_M, PCA_PlacentaT1_M, PCA_PlacentaTerm_M
load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/PCA_placenta_deciduals_allT1Term_BMval.RData")

PCA551plot <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/figures/T1TermSamples_PCA408samples.rds")
# PCAT1plot <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/figures/T1TermSamples_PCAT1plot.rds")
# PCAT2plot <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/figures/T1TermSamples_PCAT2plot.rds")
# PCATermplot <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/figures/T1TermSamples_PCATermPlot.rds")
PCAT1T2Termplot <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/figures/PCAallplot.rds")

# outlierDim1Plot_all <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/outlierDim1Plot_all.rds")
outlierDim1Plot_all <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/outlierDim1Plot_all.rds")

top2perc_GOPlot <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/top2perc_GOPlot.rds")

# PCAs <- ggarrange(PCA551plot, 
#                   PCAT1plot, PCAT2plot, PCATermplot,
#                   labels = c("A", "B", "C", "D"),
#                   ncol = 4, nrow = 1, widths = c(1,1,1,1.1),
#                   font.label=list(size = 12, color = "black", face = "bold", family = "Arial"),
#                   legend=FALSE)

PCAs <- ggarrange(PCA551plot, 
                  # PCAT1plot, PCAT2plot, PCATermplot,
                  PCAT1T2Termplot,
                  labels = c("A", "B"),
                  ncol = 2, nrow = 1, widths = c(1,3),
                  font.label=list(size = 12, color = "black", face = "bold", family = "Arial"),
                  legend=FALSE)

# PC1plots <- ggarrange(outlierDim1Plot_all, #top2perc_GOPlot, 
#           labels = c("C", "D"),
#           font.label = list(size = 12, face = "bold", color ="black"),
#           label.x = c(0, 0.05),
#           ncol = 2, widths = c(1,0.8))

tiff(file = "/home/qianhui/DNAme/Process_decidual/figures/TechFigure1_v4.tiff",
     width = 25, height = 17, units = "cm", res = 300)
theme_set(theme_pubr())
ggarrange(
               PCAs,
               # PCA551plot,PCAT1plot, PCATermplot,
               outlierDim1Plot_all,
               # outlierDim1Plot_T1Term, top2perc_GOPlot_T1Term, 
               # densityCorBoxplots,
               labels = c("", "C"),
               # ncol = 3, 
               nrow = 2,
               heights = c(1.2,2),
               
               # widths = c(1,1,1, 1,2,1),
               font.label = list(size = 12, face = "bold", color ="black")
               # legend="right",
               # common.legend = TRUE
               # layout_matrix = rbind(c(1,2,NA),c(3,3,3), c(4,5,6))
               )
dev.off()


```


# suplimentary figure
```{r}

PCA_Plot_allPlacenta <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/figures/PCA_Plot_allPlacenta.rds")

```



