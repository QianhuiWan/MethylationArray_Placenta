---
title: "technical report (mainly 450k data, 15 GEO data sets used)"
author: "Qianhui"
date: "21/11/2018"
output: html_document
---

This document is mainly for part5 of the GEO data set analysis, that is the quality control (check fetal sex) of data sets from different tissue types.

I used methods from `minfi` package to identify samples with fetal sex misslabelled (check fetal sex)

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.align = "center", error = TRUE, echo = TRUE) # fig.width = 7, 
```


# 1. load data and packages
```{r package, warning=FALSE, message=FALSE}

library(tidyverse)
library(minfi)
library(magrittr)
library(tibble)
library(data.table)
library(limma)
# library(ewastools)
library(ENmix)
library(FactoMineR)
library(doParallel)
library(ggplot2)
library(ggpubr)
library(RColorBrewer)
pal <- brewer.pal(8, "Dark2")

# GEOmeta, GEO_phenotypes
load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEOphenoDataAll.RData")

GEO_phenotypes_Filtered <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_phenotypes410_Filtered.rds")

GEO_phenotypes_Filtered <- GEO_phenotypes_Filtered[!(GEO_phenotypes_Filtered$Sample_name%in%c("GSM1617002_7668610068_R01C01","GSM1616993_7668610068_R06C02")),]

```

```{r}

GEO_baseDir <- file.path("/home/qianhui/DNAme/Process_decidual/GEO_dataSets/IDAT_all")

# get the RGset for all 392 450k samples
GEO_RGset_450k_Tissue <- read.metharray.exp(base = GEO_baseDir, 
                                        targets = GEO_phenotypes_Filtered[GEO_phenotypes_Filtered$ArrayType%in%"450K",], 
                                        extended = TRUE, force = TRUE)

# get the RGset for all 16 EPIC samples
GEO_RGset_EPIC_Tissue <- read.metharray.exp(base = GEO_baseDir, 
                                        targets = GEO_phenotypes_Filtered[GEO_phenotypes_Filtered$ArrayType%in%"EPIC",], 
                                        extended = TRUE, force = TRUE)

```

# 3. minfi: check sex of sampels.

## Functions to use minfi to check sex.

### 1) `CheckFetalSex` Function
```{r checkFetalSex}
# let argument RGsetChara to be a charactor

CheckFetalSex <- function(RGsetChara){
  registerDoParallel(cores=10)
  # get the object from character
  RGset <- get(RGsetChara)
  # get meta data
  phenoData <- pData(RGset)
  
  # get Genomic methylSets
  ctrls <- getProbeInfo(RGset,type="Control")
  ctrls <- ctrls[ctrls$Address %in% featureNames(RGset),]
  ctrl_r <- getRed(RGset)[ctrls$Address,]
  ctrl_g <- getGreen(RGset)[ctrls$Address,]
  CG.controls <- ctrls$Type %in% c("NORM_C","NORM_G")
  AT.controls <- ctrls$Type %in% c("NORM_A","NORM_T")
  if(ncol(RGset)==1){ # can't use relic if there is only one sample in the group
    print("Only one sample in this group, can't predict sex")
    }else{
      cg_grn <- ctrl_g[CG.controls,]
      rownames(cg_grn) = ctrls$ExtendedType[CG.controls]
      at_red <- ctrl_r[AT.controls,]
      rownames(at_red) = ctrls$ExtendedType[AT.controls]
      GMethSet <- RGset %>% preprocessRaw() %>% relic(at_red=at_red, cg_grn=cg_grn) %>% mapToGenome()
    }
    

  # sex check
  # phenoData to phenoData.dt
  phenoData.dt <- phenoData %>% as.data.frame() %>% rownames_to_column() %>% setDT()
  
  # add predicted sex information to Genomic methyl set
  estSex <- getSex(GMethSet)
  GMethSet <- addSex(GMethSet, sex = estSex)
  
  # add predicted fetal sex phenodata
  phenoData.dt$X <- estSex$xMed
  phenoData.dt$Y <- estSex$yMed
  phenoData.dt$predicted_sex <- estSex$predictedSex

  phenoData.dt_v2 <- phenoData.dt %>%
    mutate(predicted_sex = str_replace_all(predicted_sex, c("M"="Male","F" ="Female"))) %>% 
    setDT()

  # plotSex(GMethSet)
  # plot the X/Y chr intensities
  # it is better to put pch into 3 groups (red color marked the misslabelled samples)
  plot(Y ~ X,data=phenoData.dt_v2,
       pch=ifelse(phenoData.dt_v2$Fetal_Sex=="Female",1,4),
       # asp=1,
       xlab="X chr, median total intensity (log2)",
       ylab="Y chr, median total intensity (log2)", 
       xlim=c(11,15))
  points(Y ~ X,data=phenoData.dt_v2[Fetal_Sex !=predicted_sex],
         pch=ifelse(phenoData.dt_v2[Fetal_Sex!=predicted_sex]$Fetal_Sex=="Female",1,4),
         col=2, xlim=c(11,15))
  legend("topright",pch=c(1,4),legend=c("Female","Male"))
  title(main = RGsetChara)
  
  # samples with fetal sex in meta data not same as predicted fetal sex
  phenoData.dt_v2[Fetal_Sex !=predicted_sex] %>% as_tibble %>% 
    dplyr::select(rowname:Study, X:predicted_sex) %>% print(n=Inf)
  
  # remove intermediat data
  rm(GMethSet)
  
  # return phenoData_withPredict, the df with predicted fetal sex
  return(as_tibble(phenoData.dt_v2))
}

```


### use `CheckFetalSex`
```{r CheckFetalSexforAllTissues}

TissueRGsetNames <- c("GEO_RGset_450k_Tissue", "GEO_RGset_EPIC_Tissue")


for(i in TissueRGsetNames){
  # check fetal sex for each subset data sets
  # and save the output df, the phenodata with predicted fetal sex
  assign(paste0("GEO_phenoData", str_replace(i, "GEO_RGset",""), "_PreFS"),   
         CheckFetalSex(RGsetChara = i))

}

# save all phenoData with predicted fetal sex infotmation
GEO_phenotypes_addMinfiPredictedSex <- rbind(GEO_phenoData_450k_Tissue_PreFS,
                                        GEO_phenoData_EPIC_Tissue_PreFS)

save(GEO_phenotypes_addMinfiPredictedSex,
  file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_allPhenoData_addMinfiPredictedFetalSex.RData"
)

# RGsetChara="GEO_RGset_450k_Tissue"

```


### Draw plot for sex and predicted sex

```{r}

# The decidua (EPIC array) sex info. is NA, which should be female, so we replace the sex info. from phenodata with female
GEO_phenotypes_addMinfiPredictedSex[is.na(GEO_phenotypes_addMinfiPredictedSex$Fetal_Sex), ]$Fetal_Sex <- rep("Female",2)

# add CorrectSexInfo column
GEO_phenotypes_addMinfiPredictedSex$CorrectSexInfo <- GEO_phenotypes_addMinfiPredictedSex$Fetal_Sex == GEO_phenotypes_addMinfiPredictedSex$predicted_sex

# plot fetal sex
theme_set(theme_pubr())
GEO_phenotypes_addMinfiPredictedSex %>% 
  ggplot(aes(x=X, y=Y, colour=CorrectSexInfo, shape=predicted_sex)) +
  geom_point()+
  # geom_text(aes(label=ifelse(X<13.5 & Y <12,as.character(Sample_name),'')),hjust=0,vjust=0)+
  labs(x="X chr, median total intensity (log2)",
       y="Y chr, median total intensity (log2)",
       colour="Correctly labelled sex")+
  theme(text = element_text(size=9, colour ="black"),
        legend.position = "right")
  

GEO_phenotypes_addMinfiPredictedSex %>% 
  dplyr::select(Sample, Sample_name, Trimester, Additional_Info, Fetal_Sex, Study, ArrayType, X, Y, predicted_sex, CorrectSexInfo) %>% 
  dplyr::mutate(Outlier1=ifelse(.$Additional_Info%in%"Outlier", "Outlier", "Pure")) %>% 
  dplyr::mutate(Outlier = case_when(Sample_name %in% c("GSM1702177_7970368142_R05C02", "GSM1947213_6008581028_R01C01") ~ "Outlier",
                             !(Sample_name %in% c("GSM1702177_7970368142_R05C02", "GSM1947213_6008581028_R01C01")) ~ Outlier1)) %>% 
  dplyr::select(Sample, Sample_name, Trimester, Study, ArrayType, Outlier, X, Y, Sex=Fetal_Sex, predicted_sex, CorrectSexInfo) %>% 
  dplyr::arrange(CorrectSexInfo) %>% 
  write_csv(path = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_phenotypes_addMinfiPredictedSex.csv")

```

* There are 2 samples in the middle of this plot. They are "GSM1947399_3999997080_R02C01" and "GSM1947213_6008581028_R01C01". The former sample has more variance than other male samples, the latter sample is an outlier placenta sample which could be mixed placenta sample.


