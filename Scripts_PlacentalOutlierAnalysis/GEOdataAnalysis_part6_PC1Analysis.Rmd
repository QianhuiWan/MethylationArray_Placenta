---
title: "PC1Analysis"
author: "Qianhui"
date: "12/17/2018"
output: html_document
---

This document is mainly for part6 of the GEO data set analysis, that is pull out PC1 probes.

Cord blood only have one sample.


```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.align = "center", error = TRUE, echo = TRUE) # fig.width = 7, 
```


# 1. load data and packages
```{r package, warning=FALSE, message=FALSE}
library(tidyverse)
library(readxl)
library(minfi)
library(magrittr)
library(tibble)
library(data.table)
library(limma)
library(ewastools)
library(ENmix)
library(wateRmelon)
library(WGCNA)
library(impute)
library(missMethyl)
library(FactoMineR)
library(doParallel)
library(ggplot2)
library(RColorBrewer)
pal <- brewer.pal(8, "Dark2")
# GEOmeta, GEO_phenotypes
load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_phenotypes_add10.RData")

# Join.df_v2, GEO_phenotypes_joinedSamples, MDS_joinedSamples
load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_joinedSamples551_Beta_MDS.RData")

# MDSnorm552_Beta, MDSnorm552_M
# load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_joinedSamplesNormalised552_BetaM_MDS.RData")

# BMall_combat, MDS_normCorrect551.Beta, MDS_normCorrect551.M
# load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_joinedSamples_NormBatchCorrect551_BetaM_MDS.RData")
# load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_joinedSamples_NormBatchCorrect551_BetaM_MDS_OutlierConsidered.RData")

# MDSnormCali552_Beta, MDSnormCali552_M
# load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_joinedSamplesNormalisedCalibrated552_BetaM_MDS.RData")

# annotation needed for using functions
ann450k <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/ann450k_GEO15sets.rds")
annEPIC <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/annEPIC_GEO15sets.rds")

# BM_T1_combat, BM_Term_combat
load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/BM_T1Term_CombatCorrected.rds")

# 
# load(Residuals, file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/allSamplesResiduals_ControlCorrected.rds")
# 
# load(svaCorrect_T1_M, svaCorrect_Term_M, file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/svaCorrect_T1Term_M_CombatCorrected.rds")


```


# subset placenta data (T1) and use PCA1
```{r T1}
registerDoParallel(cores=5)
table(BM_T1_combat$PhenoData$Sample_name==colnames(BM_T1_combat$M))
PhenodataPlacenta <- BM_T1_combat$PhenoData[BM_T1_combat$PhenoData$Sample%in%"Placenta",]

Placenta_Mnorm_v1 <-  BM_T1_combat$M[,BM_T1_combat$PhenoData$Sample%in%"Placenta"]
Placenta_betaNorm <- BM_T1_combat$Beta[,BM_T1_combat$PhenoData$Sample%in%"Placenta"]

# check subseted columns are placental samples or not
table(PhenodataPlacenta$Sample_name==colnames(Placenta_Mnorm_v1))
## PCA for normalised M values
PCA_Placenta_M <- FactoMineR::PCA(base::t(Placenta_Mnorm_v1))
### plot eigen values for each PCA
barplot(PCA_Placenta_M$eig[,1], main="Eigenvalues", names.arg=1:nrow(PCA_Placenta_M$eig))
# plot(PCA_Placenta_M,choix="ind")
# calculate correlation for each probe for PCA1 and PCA2
# PCA_Placenta_M_probesSigPCA1and2 <- dimdesc(PCA_Placenta_M, axes =1:2, proba = 0.01)#444312/614861
# saveRDS(PCA_Placenta_M_probesSigPCA1and2, 
# file = "/home/qianhui/DNAme/figures-draftGA-analysis/PCA_Placenta_M_probesCorSigPCA1and2.rds")
```


## the contribution of probes to PC1 (T1 placenta samples)
```{r ContributionT1Samples}
# contribution of probs in Dim1
ProbeContrib.df <- PCA_Placenta_M$var$contrib %>% as.data.frame() %>% 
  rownames_to_column(var="Name")
###### quick look at conribution percentages:
summary(ProbeContrib.df)
###### get Dim1 top 2% probes by ordering the contribution percentages of Dim1
ProbeContrib.df.orderedTop2perc <- ProbeContrib.df[base::order(-ProbeContrib.df$Dim.1),] %>% 
   dplyr::slice(1:(0.02*nrow(ProbeContrib.df)))
saveRDS(ProbeContrib.df, 
        file ="/home/qianhui/DNAme/Process_decidual/RDSfiles/Placenta_ProbeContrib.df_T1.rds")
saveRDS(ProbeContrib.df.orderedTop2perc, 
        file ="/home/qianhui/DNAme/Process_decidual/RDSfiles/Placenta_Dim1_top2perc_forOutlierAnalysis_T1.rds")
## plot the last probe in ProbeContrib.df.orderedTop2perc, outliers still have higher DNA meth
# tiff(file = "/home/qianhui/DNAme/Process_decidual/figures/Placenta_ProbeContriTop2perc_egProbe.tiff",
#      width = 20, height = 12, units = "cm", res = 300)
# 
# plot(x=PhenodataPlacenta$, 
#      y=Placenta_betaNorm[rownames(Placenta_betaNorm)%in%ProbeContrib.df.orderedTop2perc$Name[5799],],
#      pch=ifelse(PhenodataPlacenta$Outliers=="Outlier",4,1))
# legend("topright",pch=c(4,1),legend=c("Outlier","Others"), cex=0.8)
# dev.off()
# go/KEGG for probes consistently low in DNA methylation (may be house keeping genes)====
## GO
# Dim1_corSig <- PCA_Placenta_M_probesSigPCA1and2$Dim.1$quanti %>% rownames() #%>% head(5000)
Dim1_top2perc <- ProbeContrib.df.orderedTop2perc$Name
goMeth_Dim1_top2perc <- gometh(sig.cpg = Dim1_top2perc,
                           all.cpg = rownames(Placenta_Mnorm_v1),
                           collection = "GO", array.type = "450K", prior.prob = TRUE, ann=ann450k)
goMeth_Dim1_top2perc[goMeth_Dim1_top2perc$FDR<0.05,] %>% dim()
topGO(goMeth_Dim1_top2perc, number = 10)
# saveRDS(goMeth_Dim1_top2perc, 
# file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/PlacentaGO_Dim1_top2perc_forOutlierAnalysis.rds")
# ## KEGG
# KEGG_Dim1_top2perc <- gometh(sig.cpg = Dim1_top2perc,
#                            all.cpg = rownames(Placenta_Mnorm_v1),
#                            collection = "KEGG", array.type = "EPIC", prior.prob = TRUE, ann=ann850k)
# 
# KEGG_Dim1_top2perc[KEGG_Dim1_top2perc$FDR<0.05,] %>% dim()
# topKEGG(KEGG_Dim1_top2perc, number = 10)
# 
# saveRDS(KEGG_Dim1_top2perc, 
# file = "/home/qianhui/DNAme/figures-draftGA-analysis/PlacentaKEGG_Dim1_top2perc_forOutlierAnalysis.rds")
# plot Top GO terms
## con30
top2perc_GO <- topGO(goMeth_Dim1_top2perc, number = 20) %>% rownames_to_column(var="GO_ID")
top2perc_GO$Terms <- factor(top2perc_GO$Term, levels = rev(top2perc_GO$Term))
theme_set(theme_bw())
top2perc_GOPlot_T1 <- ggplot(top2perc_GO, aes(x= Terms, y= -log10(FDR),fill=Ont)) + 
  geom_bar(stat='identity')+ #"midnightblue"
  scale_fill_hue()+
  coord_flip()+
  geom_hline(yintercept = -log10(0.05), colour="red")+
  labs(x="", y="Enrichment significance (-log10(adusted Pvalue))",fill="GO categories")+
  theme(axis.text.y = element_text(size=10, colour ="black"),
        axis.text.x = element_text(size=10, colour ="black"),
        axis.title=element_text(size=10, colour ="black"),#,face="bold"
        text = element_text(size=10, colour ="black"))
top2perc_GOPlot_T1

tiff(file = "/home/qianhui/DNAme/Process_decidual/figures/Placenta_top2perc_GOPlot_ForOutlier_T1.tiff",
    width = 20, height = 12, units = "cm", res = 300)
top2perc_GOPlot_T1
dev.off()

## plot box plot for beta values of Dim1_top2perc porbes
## manipulate data frames
PhenodataPlacenta$Outlier <- factor(ifelse(PhenodataPlacenta$Additional_Info%in%"Outlier", "Outlier", "Standard"))

phenoDataPlacenta.df <- PhenodataPlacenta %>% as.data.frame(stringsAsFactors=FALSE) %>%
  dplyr::select(c("Sample_name", "Outlier"))

placenta_beta_dim1Top2perc <- Placenta_betaNorm[rownames(Placenta_betaNorm)%in%Dim1_top2perc,]
placenta_beta_dim1Top2perc.df <- placenta_beta_dim1Top2perc %>% 
  as.data.frame() %>% rownames_to_column(var="Name") %>% melt(id.var="Name") %>% 
  `colnames<-`(c("Name", "Sample_name", "value")) %>% 
  left_join(phenoDataPlacenta.df, by="Sample_name")

outlierDim1Plot_T1 <- placenta_beta_dim1Top2perc.df %>% 
  ggplot(aes(x=Outlier, y=value))+
  geom_boxplot()+
  scale_x_discrete(labels=c("Outlier"="Outlier", "Standard"="Other Samples"))+
  labs(x="", y="Beta values")+
  theme(axis.text.y = element_text(size=12, colour ="black"),
        axis.text.x = element_text(size=12, colour ="black"),
        axis.title=element_text(size=12, colour ="black"),#,face="bold"
        text = element_text(size=12, colour ="black"))

outlierDim1Plot_T1

tiff(file = "/home/qianhui/DNAme/Process_decidual/figures/Placenta_Dim1top2percProbePlot_ForOutlier_T1.tiff",
     width = 20, height = 12, units = "cm", res = 300)
theme_set(theme_bw())
outlierDim1Plot_T1
dev.off()

```



# subset placenta data (Term) and use PCA1
```{r Term}
registerDoParallel(cores=5)
table(BM_Term_combat$PhenoData$Sample_name==colnames(BM_Term_combat$M))
PhenodataPlacenta <- BM_Term_combat$PhenoData[BM_Term_combat$PhenoData$Sample%in%"Placenta",]

Placenta_Mnorm_v1 <-  BM_Term_combat$M[,BM_Term_combat$PhenoData$Sample%in%"Placenta"]
Placenta_betaNorm <- BM_Term_combat$Beta[,BM_Term_combat$PhenoData$Sample%in%"Placenta"]

# check subseted columns are placental samples or not
table(PhenodataPlacenta$Sample_name==colnames(Placenta_Mnorm_v1))
## PCA for normalised M values
PCA_Placenta_M <- FactoMineR::PCA(base::t(Placenta_Mnorm_v1))
### plot eigen values for each PCA
barplot(PCA_Placenta_M$eig[,1], main="Eigenvalues", names.arg=1:nrow(PCA_Placenta_M$eig))

```


## use gap analysis to determine outliers for term samples
```{r eval=FALSE}
library(factoextra)
library(NbClust)
library(changepoint)

scaledM <- scale(t(Placenta_Mnorm_v1))

# Gap statistic
# nboot = 50 to keep the function speedy.
# recommended value: nboot= 500 for your analysis.
# Use verbose = FALSE to hide computing progression.
fviz_nbclust(scaledM[, 1:1000], kmeans, method = "gap_stat")+
  labs(subtitle = "Gap statistic method")

res <- NbClust(scaledM[, 1:1000], distance = "euclidean", min.nc = 2, max.nc = 10, method = "ward.D2")

##### visulise k-means clustering:

###### get kmeans values first
library(doParallel)
registerDoParallel(cores = 10)

set.seed(1314)

km.res <- kmeans(scaledM, 2, nstart = 25) #seperate in to 2 clusters

###### visulisation of kmeans:

library(doParallel)
registerDoParallel(cores = 5)
fviz_cluster(km.res, data = scaledM,
             ellipse.type = "convex",
             palette = "jco",
             ggtheme= theme_minimal())
```


## the contribution of probes to PC2 (Term placenta samples). Use Dim2, top1% probes, because Dim2 separate term outliers with other sampels.
```{r ContributionTermSamples}
# contribution of probs in Dim1
ProbeContrib.df <- PCA_Placenta_M$var$contrib %>% as.data.frame() %>% 
  rownames_to_column(var="Name")
###### quick look at conribution percentages:
summary(ProbeContrib.df)
###### get Dim1 top 1% probes by ordering the contribution percentages of Dim1
ProbeContrib.df.orderedTop2perc <- ProbeContrib.df[base::order(-ProbeContrib.df$Dim.2),] %>% 
   dplyr::slice(1:(0.01*nrow(ProbeContrib.df)))
saveRDS(ProbeContrib.df, 
        file ="/home/qianhui/DNAme/Process_decidual/RDSfiles/Placenta_ProbeContrib.df_Term.rds")
saveRDS(ProbeContrib.df.orderedTop2perc, 
        file ="/home/qianhui/DNAme/Process_decidual/RDSfiles/Placenta_Dim1_top2perc_forOutlierAnalysis_Term.rds")

# go/KEGG for probes consistently low in DNA methylation (may be house keeping genes)====
## GO
# Dim1_corSig <- PCA_Placenta_M_probesSigPCA1and2$Dim.1$quanti %>% rownames() #%>% head(5000)
Dim1_top2perc <- ProbeContrib.df.orderedTop2perc$Name
goMeth_Dim1_top2perc <- gometh(sig.cpg = Dim1_top2perc,
                           all.cpg = rownames(Placenta_Mnorm_v1),
                           collection = "GO", array.type = "450K", prior.prob = TRUE, ann=ann450k)
goMeth_Dim1_top2perc[goMeth_Dim1_top2perc$FDR<0.05,] %>% dim()
topGO(goMeth_Dim1_top2perc, number = 10)


# saveRDS(KEGG_Dim1_top2perc, 
# file = "/home/qianhui/DNAme/figures-draftGA-analysis/PlacentaKEGG_Dim1_top2perc_forOutlierAnalysis.rds")
# plot Top GO terms
## con30
top2perc_GO <- topGO(goMeth_Dim1_top2perc, number = 20) %>% rownames_to_column(var="GO_ID")
top2perc_GO$Terms <- factor(top2perc_GO$Term, levels = rev(top2perc_GO$Term))
theme_set(theme_bw())
top2perc_GOPlot_Term <- ggplot(top2perc_GO, aes(x= Terms, y= -log10(FDR),fill=Ont)) + 
  geom_bar(stat='identity')+ #"midnightblue"
  scale_fill_hue()+
  coord_flip()+
  geom_hline(yintercept = -log10(0.05), colour="red")+
  labs(x="", y="Enrichment significance (-log10(adusted Pvalue))",fill="GO categories")+
  theme(axis.text.y = element_text(size=10, colour ="black"),
        axis.text.x = element_text(size=10, colour ="black"),
        axis.title=element_text(size=10, colour ="black"),#,face="bold"
        text = element_text(size=10, colour ="black"))
top2perc_GOPlot_Term

tiff(file = "/home/qianhui/DNAme/Process_decidual/figures/Placenta_top1perc_GOPlot_ForOutlier_Term.tiff",
    width = 20, height = 12, units = "cm", res = 300)
top2perc_GOPlot_Term
dev.off()

## plot box plot for beta values of Dim1_top2perc porbes
## manipulate data frames
PhenodataPlacenta$Outlier <- factor(ifelse(PhenodataPlacenta$Additional_Info%in%"Outlier", "Outlier", "Standard"))

phenoDataPlacenta.df <- PhenodataPlacenta %>% as.data.frame(stringsAsFactors=FALSE) %>%
  dplyr::select(c("Sample_name", "Outlier"))

placenta_beta_dim1Top2perc <- Placenta_betaNorm[rownames(Placenta_betaNorm)%in%Dim1_top2perc,]
placenta_beta_dim1Top2perc.df <- placenta_beta_dim1Top2perc %>% 
  as.data.frame() %>% rownames_to_column(var="Name") %>% melt(id.var="Name") %>% 
  `colnames<-`(c("Name", "Sample_name", "value")) %>% 
  left_join(phenoDataPlacenta.df, by="Sample_name")

outlierDim1Plot_Term <- placenta_beta_dim1Top2perc.df %>% 
  ggplot(aes(x=Outlier, y=value))+
  geom_boxplot()+
  scale_x_discrete(labels=c("Outlier"="Outlier", "Standard"="Other Samples"))+
  labs(x="", y="Beta values")+
  theme(axis.text.y = element_text(size=12, colour ="black"),
        axis.text.x = element_text(size=12, colour ="black"),
        axis.title=element_text(size=12, colour ="black"),#,face="bold"
        text = element_text(size=12, colour ="black"))

outlierDim1Plot_Term

tiff(file = "/home/qianhui/DNAme/Process_decidual/figures/Placenta_Dim1top1percProbePlot_ForOutlier_Term.tiff",
     width = 20, height = 12, units = "cm", res = 300)
theme_set(theme_bw())
outlierDim1Plot_Term
dev.off()

```
