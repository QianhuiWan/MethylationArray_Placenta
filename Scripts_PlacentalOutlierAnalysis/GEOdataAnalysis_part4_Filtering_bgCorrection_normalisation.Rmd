---
title: "technical report (mainly 450k data, 15 GEO data sets used)"
author: "Qianhui"
date: "21/11/2018"
output: html_document
---

This document is mainly for part4 of the GEO data set analysis, filtering, dye bias correction and backgroud correction steps.

The preprocessed beta values and the correspounding M values were stored in a list for each tissue type. 
The Msets for each tissue types were saved as RData as well.


```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.align = "center", error = TRUE, echo = TRUE) # fig.width = 7, 
```


# 1. load data and packages
```{r package, warning=FALSE, message=FALSE}

library(tidyverse)
library(readxl)
library(minfi)
library(magrittr)
library(tibble)
library(data.table)
library(limma)
library(ewastools)
library(ENmix)
library(wateRmelon)
library(FactoMineR)
library(ChAMP)
library(mclust)
library(doParallel)
library(ggplot2)
library(RColorBrewer)
pal <- brewer.pal(8, "Dark2")

# GEOmeta, GEO_phenotypes
load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_phenotypes_add10.RData")
GEO_phenotypes_Filtered <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_phenotypes410_Filtered.rds")
GEO_phenotypes_Filtered <- GEO_phenotypes_Filtered[!(GEO_phenotypes_Filtered$Sample_name%in%c("GSM1617002_7668610068_R01C01","GSM1616993_7668610068_R06C02")),]

# crossreactive probes-- EPIC
crossreactiveProbesEPIC <- read_csv("/home/qianhui/DNAme/Process-QH/13059_2016_1066_MOESM1_ESM-cross-reactive.csv")
colnames(crossreactiveProbesEPIC)[1] <- "ProbeNames"

# crossreactive probes--450k
crossreactiveProbes450k <- read_excel("/home/qianhui/DNAme/Process-QH/48639-non-specific-probes-Illumina450k.xlsx", sheet = 1)
colnames(crossreactiveProbes450k)[1] <- "ProbeNames"

# annotation needed for using functions
ann450k <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/ann450k_GEO15sets.rds")
annEPIC <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/annEPIC_GEO15sets.rds")

```


# 2. Sample and probe filtering & Background and dye bias correction & nomalisation

There are many tissue types for normal tissue samples around placenta, such as cord blood, chorionic plate and so on. We need to normalise different tissue separately.

There are 6 tissue types (we choose tissue types located near placenta) in total from GEO.


## A) Function for filtering and bg correction and normalisation

FilterFUN & use FilterFUN

TissueType argument in this function could be: Placenta, Amnion, Chorion, Decidua, Maternal whole blood, Umbilical cord blood.


### Function that need to be called in `FilterFUN` to get the number of beads for each probe

```{r}
# Tissue: Amnoin, Chorion, Decidua, maternal whole blood, and umbilical cord blood.

# ArrayType: 450K or EPIC

getRGset_extended <- function(ArrayType){
  # base directory
  GEO_baseDir <- file.path("/home/qianhui/DNAme/Process_decidual/GEO_dataSets/IDAT_all")
  
  if(ArrayType=="450K"){
    # get 450k meta data
    kept450k <- GEO_phenotypes$ArrayType=='450K'& 
              !(GEO_phenotypes$Sample_name%in%c("GSM1617002_7668610068_R01C01","GSM1616993_7668610068_R06C02"))
    GEO_phenotypes_sub <- GEO_phenotypes[kept450k,]
    
   }else if(ArrayType=="EPIC"){
    # get EPIC meta data
    GEO_phenotypes_sub <- GEO_phenotypes[GEO_phenotypes$ArrayType=='EPIC',]
   }
    
  # get the RGset for this tissue
  GEO_RGset_extended <- read.metharray.exp(base = GEO_baseDir, 
                                           targets = GEO_phenotypes_sub, 
                                           extended = TRUE, force = TRUE)
  
  return(GEO_RGset_extended)
  
}

```


### Function `FilterFUN`

If a probe has less than 3 beads, we need to remove it because the intensity of this probe is not reliable.

```{r FilterFUN}
  # dropSNP, dropXY: FALSE or TRUE; dropSNP=TRUE means drop all probes related with SNPs
  # annotation: ann450k or annEPIC, a DataFrame

FilterFun <- function(RGsetChara, crossreactiveProbes, annotation, 
                      DropXreactive, DropSNP, DropXY){
    
  registerDoParallel(cores = 10)
  # get the object from character
  RGset <- RGsetChara
  
  # get methylset
  methylset_raw <- preprocessRaw(RGset) # 866238

  # filtering of probes
  ## drop P
  detP <- minfi::detectionP(RGset)
  Failed <- detP > 0.01
  methylset_P <- methylset_raw[rowSums(Failed)==0,] #846991

  ## drop probes with <3 beads
  if(identical(annotation, ann450k)){
    
  EpicRGset_extended <- getRGset_extended(ArrayType = "450K")
  
  }else if(identical(annotation, annEPIC)){
    
  EpicRGset_extended <- getRGset_extended(ArrayType = "EPIC")
  }

  BeadCount <- getNBeads(EpicRGset_extended)
  RemainProbe <- rowSums(BeadCount<3) < 0.05 * (ncol(BeadCount))
  EpicRGset_extended_Bead <- EpicRGset_extended[RemainProbe,]
  methylset_rawBead <- preprocessRaw(EpicRGset_extended_Bead) # bead number filter

  methylset_PBead <- methylset_P[rownames(methylset_P)%in%rownames(methylset_rawBead),] # 834351

  ## drop cross-reactive probes
  if(DropXreactive==TRUE){
  keep <- !(featureNames(methylset_PBead) %in% crossreactiveProbes$ProbeNames)
  methylset_PBeadX <- methylset_PBead[keep, ] # 792070
  }else{
  methylset_PBeadX <- methylset_PBead
  }
  
  ## drop SNPs
  ### if I use DropSNP argument, I drop all probes with SNPs
  if(DropSNP==TRUE){
  GRaSet_meth_PBeadX <- methylset_PBeadX %>% ratioConvert() %>% mapToGenome()
  GRaSet_meth_PBeadXAddSNPinfo <- addSnpInfo(GRaSet_meth_PBeadX)
  GRaSet_meth_PBeadXsnp <- dropLociWithSnps(GRaSet_meth_PBeadXAddSNPinfo,
                                  snps = c("CpG", "SBE", "Probe"), maf = 0)

  meth_PBeadXsnp <- methylset_PBeadX[rownames(methylset_PBeadX)%in% rownames(GRaSet_meth_PBeadXsnp), ]

  
  }else{
  ### else, I only drop unwanted SNP related probes, that is SNPs at CpG and SBE sites
  GRaSet_meth_PBeadX <- methylset_PBeadX %>% ratioConvert() %>% mapToGenome()
  GRaSet_meth_PBeadXAddSNPinfo <- addSnpInfo(GRaSet_meth_PBeadX)
  GRaSet_meth_PBeadXsnp <- dropLociWithSnps(GRaSet_meth_PBeadXAddSNPinfo, 
                                            snps = c("CpG", "SBE"), maf = 0)

  meth_PBeadXsnp <- methylset_PBeadX[rownames(methylset_PBeadX)%in% rownames(GRaSet_meth_PBeadXsnp), ]
  
  }

  ## drop probes on X, Y chr
  if(DropXY==TRUE){
    
  keep <- !(featureNames(meth_PBeadXsnp) %in% annotation$Name[annotation$chr %in% c("chrX", "chrY")])
  meth_PBeadXsnpXY <- meth_PBeadXsnp[keep, ] # 600k

  }else{
    
  meth_PBeadXsnpXY <- meth_PBeadXsnp
  }
  
  # the filtered CpGs
  # filteredCpGs <- setdiff(featureNames(methylset_raw), featureNames(meth_PBeadXsnpXY))

  # remove files not need
  rm(methylset_raw, EpicRGset_extended,     
     GRaSet_meth_PBeadX, GRaSet_meth_PBeadXAddSNPinfo, GRaSet_meth_PBeadXsnp)
  
  return(meth_PBeadXsnpXY)

}

```

** I will do nomalisation in next Rmd document, because there may be batch effects between GEO studies, I need to use BMIQ and modified BMIQ to normalise all data sets.**



## B) Use the function FilterFUN to get **filtered Methyl sets** for all the samples from 6 kinds of tissues located around placenta during early development.

* filter out failed samples first for GEO_RGset_450k_normalPlacenta[,5] (GSM1617002_7668610068_R01C01) and GEO_RGset_450k_MaternalBlood[,8] (GSM1616993_7668610068_R06C02).

These 2 failed samples are placental sample and maternal blood sample respectively, and both of them were from first trimester.

### read in EPIC and 450k seperately and do preprocess ENmix

```{r}

GEO_baseDir <- file.path("/home/qianhui/DNAme/Process_decidual/GEO_dataSets/IDAT_all")

# get the RGset for all 392 450k samples
GEO_RGset_450k <- read.metharray.exp(base = GEO_baseDir, 
                                     targets = GEO_phenotypes_Filtered[GEO_phenotypes_Filtered$ArrayType%in%"450K",], 
                                     extended = TRUE, force = TRUE)

# get the RGset for all 16 EPIC samples
GEO_RGset_EPIC <- read.metharray.exp(base = GEO_baseDir, 
                                     targets = GEO_phenotypes_Filtered[GEO_phenotypes_Filtered$ArrayType%in%"EPIC",], 
                                     extended = TRUE, force = TRUE)

```


get filtered Msets
```{r}

GEO_Mset_450k_Fil <- FilterFun(RGsetChara = GEO_RGset_450k,
          crossreactiveProbes = crossreactiveProbes450k, 
          annotation = ann450k, DropXreactive = TRUE, 
          DropSNP = TRUE, DropXY = TRUE)

GEO_Mset_EPIC_Fil <- FilterFun(RGsetChara = GEO_RGset_EPIC,
          crossreactiveProbes = crossreactiveProbesEPIC, 
          annotation = annEPIC, DropXreactive = TRUE,
          DropSNP = TRUE, DropXY = TRUE)

```

get common probes
```{r}

intersetProbes <- intersect(rownames(GEO_Mset_450k_Fil), rownames(GEO_Mset_EPIC_Fil))


GEO_Mset_450k <- preprocessRaw(GEO_RGset_450k)
GEO_Mset_EPIC <- preprocessRaw(GEO_RGset_EPIC)


RemovedProbe_450k <- GEO_Mset_450k[!(rownames(GEO_Mset_450k)%in%intersetProbes),] %>% rownames()


RemovedProbe_EPIC <- GEO_Mset_EPIC[!(rownames(GEO_Mset_EPIC)%in%intersetProbes),] %>% rownames()

```


Preprocess Enmix
```{r}

GEO_Mset_450k_Fil_enmix <- preprocessENmix(GEO_RGset_450k, exCpG = RemovedProbe_450k, nCores = 10)

GEO_Mset_EPIC_Fil_enmix <- preprocessENmix(GEO_RGset_EPIC, exCpG = RemovedProbe_EPIC, nCores = 10)

```

<!-- Preprocess quantile 1 -->
<!-- ```{r} -->

<!-- GEO_Mset_450k_Tissue_Fil_ENQN1 <- norm.quantile(GEO_Mset_450k_Tissue_Fil_enmix, method = "quantile1") -->

<!-- GEO_Mset_EPIC_Tissue_Fil_ENQN1 <- norm.quantile(GEO_Mset_EPIC_Tissue_Fil_enmix, method = "quantile1") -->

<!-- ``` -->


Get Beta and M values from Msets
```{r}

betaList <- list()
Mlist <- List()

for (i in c("GEO_Mset_450k_Fil_enmix","GEO_Mset_EPIC_Fil_enmix")){
    Mset <- get(i)
    beta <- minfi::getBeta(Mset) 
    betaList[[i]] <- beta %>% as.data.frame() %>% rownames_to_column(var="Probe") 
    
    ## calculate M values
    M <- log2(beta/(1 - beta))
    M_v1 <- M[apply(M, 1, function(x) all(is.finite(x))), ]
    Mlist[[i]] <- M_v1 %>% as.data.frame() %>% rownames_to_column(var="Probe") 
}
   
```

bind beta and M values from 450k and EPIC array
```{r}

Beta_all <- betaList$GEO_Mset_450k_Fil_enmix %>% 
  left_join(betaList$GEO_Mset_EPIC_Fil_enmix, by="Probe") %>% 
  column_to_rownames(var="Probe") %>% 
  as.matrix()

M_all <- Mlist$GEO_Mset_450k_Fil_enmix %>% 
  left_join(Mlist$GEO_Mset_EPIC_Fil_enmix, by="Probe") %>% 
  column_to_rownames(var="Probe") %>% 
  as.matrix()

```

PCA for data before normalisation
```{r}
PCA_Mall <- PCA(t(M_all))
```

matched phenodata for 408 samples
```{r}
Matched_pd <- GEO_phenotypes_Filtered[match(colnames(M_all), GEO_phenotypes_Filtered$Sample_name),]
```

clustering for data before normalisation
```{r}
library(mclust)
source(file = "~/DNAme/Process_decidual/GEO_TechPaper/Functions/GEOdataAnalysis_ggplotPCAFUN.R")

Mall_pcaRES <- ggplotPCA(PCA_Placenta_M = PCA_Mall, 
                         Matched_pd = Matched_pd, 
                         value = "Mval_allNorm")

Mall_pcaRES %>% 
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Study), alpha = 1, size = 5)+ 
  # scale_color_manual(values = namedPal2)+
  scale_shape_manual(values=1:11)+
  labs(x="PC1", y="PC2")+
  theme(text = element_text(size=20))


df <- PCA_Mall$ind$coord %>% as.data.frame() %>% rownames_to_column(var="Sample_name") %>% 
  left_join(GEO_phenotypes_Filtered, by="Sample_name") %>% column_to_rownames(var="Sample_name")

a1 <- mclust::Mclust(df[,c("Dim.1","Dim.2")],2) #for 2 groups
table(a1$classification,df$Sample)
with(df,plot(Dim.2 ~ Dim.1,pch=as.numeric(as.factor(Sample)),col=a1$classification))
with(df,legend("topright",levels(as.factor(Sample)),pch=1:6))

```


```{r}
library(ChAMP)
BetaAllNorm <- champ.norm(beta=Beta_all,
             # rgSet=myLoad$rgSet,
             # mset=myLoad$mset,
             resultsDir="~/DNAme/Process_decidual/RDSfiles/",
             method="BMIQ",
             plotBMIQ=FALSE,
             arraytype="450K",
             cores=3)
  
  # M values
  Mnorm <- log2(BetaAllNorm/(1 - BetaAllNorm))
  MAllNorm <- Mnorm[apply(Mnorm, 1, function(x) all(is.finite(x))), , drop=FALSE]
  
  
  NormBMlist <- list(NormBAll=BetaAllNorm, NormMAll=MAllNorm, 
                     phenoDataAll=Matched_pd)
  
  saveRDS(NormBMlist, file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/NormBMlist_300k.rds")
  

```

PCA for data after normalisation
```{r}

PCA_all <- PCA(t(MAllNorm)) 

saveRDS(PCA_all, file  = "/home/qianhui/DNAme/Process_decidual/RDSfiles/PCA_all.Rds")

```


clustering
```{r}

source(file = "~/DNAme/Process_decidual/GEO_TechPaper/Functions/GEOdataAnalysis_ggplotPCAFUN.R")

Mall_pcaRES <- ggplotPCA(PCA_Placenta_M = PCA_all, 
                         Matched_pd = Matched_pd, 
                         value = "Mval_allNorm")

Mall_pcaRES %>% 
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Study), alpha = 1, size = 5)+ 
  # scale_color_manual(values = namedPal2)+
  geom_vline(aes(xintercept=quantile(PCA_all$ind$coord[, 1], 0.75)+ 1.5*IQR(PCA_all$ind$coord[, 1])),
             linetype=4, colour="black")+
  geom_vline(aes(xintercept=quantile(PCA_all$ind$coord[, 1], 0.75)+ 3*IQR(PCA_all$ind$coord[, 1])),
             linetype=4, colour="black")+
  scale_shape_manual(values=1:11)+
  labs(x="PC1", y="PC2")+
  theme(text = element_text(size=8))


df <- PCA_all$ind$coord %>% as.data.frame() %>% rownames_to_column(var="Sample_name") %>% 
  left_join(Matched_pd, by="Sample_name") %>% column_to_rownames(var="Sample_name")

a1 <- mclust::Mclust(df[,c("Dim.1","Dim.2")],2) #for 2 groups
table(a1$classification,df$Sample)
with(df,plot(Dim.2 ~ Dim.1,pch=as.numeric(as.factor(Sample)),col=a1$classification))
with(df,legend("topright",levels(as.factor(Sample)),pch=1:6))

a1$z %>% as.data.frame() %>% rownames_to_column() %>% arrange(V2)
```






