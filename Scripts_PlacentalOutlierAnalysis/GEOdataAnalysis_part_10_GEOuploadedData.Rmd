---
title: "technical report (mainly 450k data, 15 GEO data sets used)"
author: "Qianhui"
date: "29/11/2018"
output: html_document
---

This document is mainly for part5 of the GEO data set analysis, that is the normalisation step.


```{r setup, include=FALSE}

knitr::opts_chunk$set(fig.align = "center", error = TRUE, echo = TRUE) # fig.width = 7, 

```


# 1. load data and packages
```{r package, warning=FALSE, message=FALSE, echo=TRUE, results='hide'}

library(tidyverse)
library(readxl)
library(minfi)
library(magrittr)
library(tibble)
library(data.table)
library(limma)
library(ewastools)
library(ENmix)
library(wateRmelon)
library(FactoMineR)
library(WGCNA)
library(impute)
library(ChAMP)
library(sva)
library(quantro)
library(doParallel)
library(ggplot2)
library(RColorBrewer)
pal <- brewer.pal(8, "Dark2")

# GEOmeta, GEO_phenotypes
load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_phenotypes_add10.RData")

# # Msets
# # Mset_450k_normalPlacenta_v1, Mset_EPIC_normalPlacenta, Mset_EPIC_normalPlacenta_ourStudy, 
# # Mset_450k_Amnion, Mset_EPIC_Amnion, # Mset_450k_Chorion, Mset_EPIC_Chorion,
# # Mset_450k_Decidua, Mset_EPIC_Decidua, # Mset_450k_MaternalBlood_v1, Mset_450k_mesenchyme,
# # Mset_450k_trophoblast, Mset_450k_UC, Mset_450k_UCB,
# load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/MsetsOf9TissueTypes.RData")

# Join.df_v2, Join.df_M_v1, GEO_phenotypes_joinedSamples, MDS_joinedSamples, 
load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_joinedSamples408_Beta_MDS.RData")

PCA_all408_bgCorrected <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/PCA_all408_bgCorrected.rds")

# annotation needed for using functions
ann450k <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/ann450k_GEO15sets.rds")
annEPIC <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/annEPIC_GEO15sets.rds")

```


# 2. Nomalisation

There are many tissue types for normal tissue samples around placenta, such as cord blood, chorionic plate and so on. I used modified BMIQ method to normalise different tissue separately. 

There are 6 tissue types (we choose tissue types located near placenta) in total from GEO.

## Function for and normalisation

### normalise Msets with BMIQ method
```{r NormCaliFUN}
  # annotation: ann450k or annEPIC, need to be a DataFrame, annataion from the illumina annotation package
registerDoParallel(cores = 10)
  
  # do BMIQ normalisation for all 300K beta values
  Msets <- c('Mset_450k_normalPlacenta_v1', 'Mset_EPIC_normalPlacenta', 'Mset_EPIC_normalPlacenta_ourStudy',
           'Mset_450k_Amnion', #'Mset_EPIC_Amnion',
           'Mset_450k_Chorion', #'Mset_EPIC_Chorion',
           'Mset_450k_Decidua', 'Mset_EPIC_Decidua', 
           'Mset_450k_MaternalBlood_v1', #'Mset_450k_mesenchyme','Mset_450k_trophoblast', 
           # 'Mset_450k_UC', 
           'Mset_450k_UCB')
  
  ## normalise beta value for this tissue type
  ListToJoin <- list()
  
  # get BMIQ normalised beta values
  for(i in Msets){
  # get the object
  Mset <- get(i)
  
  # names for the list
  listElements <- paste0("normB", str_replace_all(i, "Mset", ""), ".df")

  # fill the list with beta values
  ListToJoin[[listElements]] <- wateRmelon::BMIQ(beta.v = Mset) %>% 
    as.data.frame() %>% rownames_to_column(var="Probe")
  
  
  BetaAllNorm <- champ.norm(beta=Join.df_v2,
             # rgSet=myLoad$rgSet,
             # mset=myLoad$mset,
             resultsDir="~/DNAme/Process_decidual/RDSfiles/",
             method="BMIQ",
             plotBMIQ=FALSE,
             arraytype="450K",
             cores=3)
  
  # M values
  Mnorm <- log2(BetaAllNorm/(1 - BetaAllNorm))
  MAllNorm <- Mnorm[apply(Mnorm, 1, function(x) all(is.finite(x))), , drop=FALSE]
  
  }

 PCA_all <- PCA(t(MAllNorm)) 
source(file = "~/DNAme/Process_decidual/GEO_TechPaper/Functions/GEOdataAnalysis_ggplotPCAFUN.R")

Mall_pcaRES <- ggplotPCA(PCA_Placenta_M = PCA_all, 
                         Matched_pd = GEO_phenotypes_joinedSamples, 
                         value = "Mval_allNorm")

Mall_pcaRES %>% 
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Study), alpha = 1, size = 5)+ 
  # scale_color_manual(values = namedPal2)+
  scale_shape_manual(values=1:11)+
  labs(x="PC1", y="PC2")+
  theme(text = element_text(size=20))


df <- PCA_all$ind$coord %>% as.data.frame() %>% rownames_to_column(var="Sample_name") %>% 
  left_join(GEO_phenotypes_joinedSamples, by="Sample_name") %>% column_to_rownames(var="Sample_name")

a1 <- mclust::Mclust(df[,c("Dim.1","Dim.2")],2) #for 2 groups
table(a1$classification,df$Sample)
with(df,plot(Dim.2 ~ Dim.1,pch=as.numeric(as.factor(Sample)),col=a1$classification))
with(df,legend("topright",levels(as.factor(Sample)),pch=1:6))


  # left_join values form all samples
  Join_allNorm.df <- ListToJoin %>% purrr::reduce(left_join, by = "Probe")
  # omit na values
  Join_allNorm.df_v1 <- na.omit(Join_allNorm.df)
  # as matrix
  Join_allNorm.df_v2 <- Join_allNorm.df_v1 %>% remove_rownames() %>%
  column_to_rownames(var="Probe") %>% as.matrix() # 298179
  
  # phenotypes of all samples form all the tissue types
  phenotype_matched <- GEO_phenotypes[match(colnames(Join_allNorm.df_v2),GEO_phenotypes$Sample_name),]
  
  # M values
  Mnorm <- log2(Join_allNorm.df_v2/(1 - Join_allNorm.df_v2))
  Mnorm_v1 <- Mnorm[apply(Mnorm, 1, function(x) all(is.finite(x))), , drop=FALSE]
  
  # plot MDS
  ## MDS for M values
  MDS_norm408.M <- plotMDS(Mnorm_v1, top = nrow(Mnorm_v1), 
                           labels = phenotype_matched$Sample, gene.selection = "common")
  ## MDS for Beta values
  MDS_norm408.Beta <- plotMDS(Join_allNorm.df_v2, top = nrow(Join_allNorm.df_v2), 
                           labels = phenotype_matched$Sample, gene.selection = "common")

  # put into a list
  NormBMlist <- list(NormBAll=Join_allNorm.df_v2, NormMAll=Mnorm_v1, 
                     phenoDataAll=phenotype_matched, 
                     MDS_norm408.Beta=MDS_norm408.Beta, MDS_norm408.M=MDS_norm408.M)
  
  saveRDS(NormBMlist, file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/NormBMlist.rds")
  
```  
  

# 3. MDS plot using all data

## A) plot all values (408 samples) in one MDS plot

### `plotAll` function
```{r joinAllandPlotAll}
# value-- Beta or M
# TissueBMvalInfo -- a tibble containing BM names

plotAll <- function(BMvalue, GEO_phenotypes_joinedSamples){
  registerDoParallel(cores = 10)
  
  #plotMDS plots
  ## phenodata for these samples
  GEO_phenotypes_408 <- GEO_phenotypes_joinedSamples[match(colnames(BMvalue),
                                                               GEO_phenotypes_joinedSamples$Sample_name),]
  ## check names all in same order or not
  table(colnames(BMvalue)==GEO_phenotypes_408$Sample_name)

  ## plot MDS plot
  par(mfrow=c(1,1))
  MDS_norm408 <- plotMDS(BMvalue, top=nrow(BMvalue), labels= GEO_phenotypes_408$Sample,
                         gene.selection="common") 

  # plot density plot
  par(mfrow=c(1,1), cex=0.8)
  densityPlot(BMvalue, sampGroups = GEO_phenotypes_408$Sample, xlab = "Normalised Beta values")
  
  # return Join.df_v2, GEO_phenotypes_norm408 and MDS_norm408
  output_List <- list(JoinAll=BMvalue, phenoDataAll=GEO_phenotypes_408, MDSnorm408=MDS_norm408)
  return(output_List)
}

```


### use `plotAll` function
```{r USEplotAll}

MDSnormCali408_Beta <- plotAll(BMvalue = NormBMlist$NormBAll,
                           GEO_phenotypes_joinedSamples = NormBMlist$phenoDataAll)

MDSnormCali408_M <- plotAll(BMvalue = NormBMlist$NormMAll, 
                        GEO_phenotypes_joinedSamples = NormBMlist$phenoDataAll)


save(MDSnormCali408_Beta, MDSnormCali408_M,
     file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_joinedSamplesNormalisedCalibrated408_BetaM_MDS.RData")

```


## C) MDS for all 408 samples use `ggplot`

### function for plot MDS with ggplot -- `ggplotMDS` function
```{r ggplotMDS}

library(RColorBrewer)
colorFun <- colorRampPalette(brewer.pal(9, "Set1"))
pal2 <- colorFun(13)

# set up df for ggplot
## check sample orders were the same or not
table(colnames(MDSnormCali408_Beta$JoinAll)==MDSnormCali408_Beta$phenoDataAll$Sample_name)
table(colnames(MDSnormCali408_M$JoinAll)==MDSnormCali408_M$phenoDataAll$Sample_name)

# ggplotMDS function
## value -- Beta or M
ggplotMDS <- function(MDS_norm408, GEO_phenotypes_norm408, value){
  
  new_plotDF <- data.frame(MDS_norm408$x, 
      MDS_norm408$y,
      GA = GEO_phenotypes_norm408$Gestation,
      FetalSex= GEO_phenotypes_norm408$Fetal_Sex,
      Tissue=str_replace_all(GEO_phenotypes_norm408$Sample, c(
                                        "placental"="Placental",
                                        "umbilical"="Umbilical")),
      Trimester=GEO_phenotypes_norm408$Trimester,
      Study=GEO_phenotypes_norm408$Study,
      Outlier=ifelse(GEO_phenotypes_norm408$Additional_Info%in%"Outlier", "Outlier", "Standard"),
      ArrayType=GEO_phenotypes_norm408$ArrayType
    
  )

  colnames(new_plotDF) <- c("x", "y", "Gestational age", "FetalSex", "Tissue", "Trimester", "Study", "Outlier", "ArrayType")

  # Plot the new dataframe
  ## color to use
  namedPal2 <- pal2 %>% `names<-`(unique(new_plotDF$Tissue))
  TissueShape <- factor(new_plotDF$Tissue)

  MDSplot_norm408 <- new_plotDF %>%
    ggplot(aes(x, y)) + 
    geom_point(aes(shape = Study, col=Trimester), alpha = 1, size = 5)+ 
    # scale_color_manual(values = namedPal2)+
    scale_shape_manual(values=1:length(new_plotDF$Study))+
    labs(x="Dimension 1", y="Dimension 2")+
    theme(text = element_text(size=20))
    # axis.text.x = element_text(angle=90, hjust=1)) 


  # save the MDS plot as pdf:
  pdf(file = paste0("/home/qianhui/DNAme/Process_decidual/figures/MDSplot-Normalised", value, "_joinedGEOsamples408.pdf"), 
    width = 13, height = 7)

  theme_set(theme_bw())
  MDSplot_norm408
  dev.off()

  # save as tiff
  tiff(file = paste0("/home/qianhui/DNAme/Process_decidual/figures/MDSplot-Normalised", value, "_joinedGEOsamples408.tiff"), 
     width = 20,height = 15, units="cm",  res = 300)

  theme_set(theme_bw())
  MDSplot_norm408
  dev.off()
  
  # show the plot
  theme_set(theme_bw())
  MDSplot_norm408 %>% print()
  
  # return new_plotDF
  return(new_plotDF)
}

```


### use `ggplotMDS` function
```{r useggplotMDS}

# for MDSnormCali408_Beta
AllBetaMDSinfo <- ggplotMDS(MDS_norm408 = MDSnormCali408_Beta$MDSnorm408, 
          GEO_phenotypes_norm408 = MDSnormCali408_Beta$phenoDataAll, 
          value = "Beta")

AllBetaMDSinfo %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  # scale_color_manual(values = namedPal2)+
  scale_shape_manual(values=1:length(AllBetaMDSinfo$Study))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))


# for MDSnormCali408_M
AllMMDSinfo <- ggplotMDS(MDS_norm408 = MDSnormCali408_M$MDSnorm408, 
          GEO_phenotypes_norm408 = MDSnormCali408_M$phenoDataAll, 
          value = "M")

AllMMDSinfo %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  # scale_color_manual(values = namedPal2)+
  scale_shape_manual(values=1:length(AllMMDSinfo$Study))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))

```


# add detection P values for all beta values from our dataset (GSE131945)

## beta values
```{r}

# GEO_RGset_EPIC_normalPlacenta_ourStudy, GEO_phenoData_EPIC_normalPlacenta_ourStudy
load(file ="/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_RG&pData_normalPlacenta.RData")

# NormBMlist <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/NormBMlist.rds")
load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/MsetsOf9TissueTypes.RData")


Beta_ourStudy <- wateRmelon::BMIQ(beta.v = Mset_EPIC_normalPlacenta_ourStudy) %>% 
  as.data.frame() %>% rownames_to_column(var="Probe")

detectionP <- minfi::detectionP(GEO_RGset_EPIC_normalPlacenta_ourStudy) %>% 
  `colnames<-`(paste0(colnames(.), "detP")) %>% 
  as.data.frame() %>% rownames_to_column(var="Probe")

# subset
SampleBetaAndDetP <- Beta_ourStudy %>% 
  dplyr::left_join(detectionP, by="Probe") %>% 
  dplyr::select(Probe, `201332340153_R01C01`, `201332340153_R01C01detP`, `201332340153_R03C01`, `201332340153_R03C01detP`, 
                `201414140063_R05C01`, `201414140063_R05C01detP`, `201414140063_R06C01`, `201414140063_R06C01detP`,
                `201414140060_R01C01`, `201414140060_R01C01detP`, `201414140063_R07C01`, `201414140063_R07C01detP`,
                `201414140060_R04C01`, `201414140060_R04C01detP`, `201332340153_R05C01`, `201332340153_R05C01detP`,
                `201332340172_R03C01`, `201332340172_R03C01detP`, `201414140063_R08C01`, `201414140063_R08C01detP`
                )

write_csv(SampleBetaAndDetP, path = "/home/qianhui/DNAme/Process_decidual/RDSfiles/SampleBetaAndDetP.csv")

```


## intensities
```{r}

Mset_EPIC_normalPlacenta_ourStudy <- preprocessRaw(GEO_RGset_EPIC_normalPlacenta_ourStudy)

Meth <- getMeth(Mset_EPIC_normalPlacenta_ourStudy) %>% 
  `colnames<-`(paste0(colnames(.), "Meth")) %>% 
  as.data.frame() %>% rownames_to_column(var="Probe")

UnMeth <- getUnmeth(Mset_EPIC_normalPlacenta_ourStudy) %>% 
  `colnames<-`(paste0(colnames(.), "UnMeth")) %>% 
  as.data.frame() %>% rownames_to_column(var="Probe")

SampleMethAndDetP <- Meth %>% 
  dplyr::left_join(UnMeth, by="Probe") %>% 
  dplyr::left_join(detectionP, by="Probe") %>% 
  dplyr::select(Probe, `201332340153_R01C01UnMeth`, `201332340153_R01C01Meth`, `201332340153_R01C01detP`, 
                `201332340153_R03C01UnMeth`, `201332340153_R03C01Meth`, `201332340153_R03C01detP`, 
                `201414140063_R05C01UnMeth`, `201414140063_R05C01Meth`, `201414140063_R05C01detP`, 
                `201414140063_R06C01UnMeth`, `201414140063_R06C01Meth`, `201414140063_R06C01detP`,
                `201414140060_R01C01UnMeth`, `201414140060_R01C01Meth`, `201414140060_R01C01detP`, 
                `201414140063_R07C01UnMeth`, `201414140063_R07C01Meth`, `201414140063_R07C01detP`,
                `201414140060_R04C01UnMeth`, `201414140060_R04C01Meth`, `201414140060_R04C01detP`, 
                `201332340153_R05C01UnMeth`, `201332340153_R05C01Meth`, `201332340153_R05C01detP`,
                `201332340172_R03C01UnMeth`, `201332340172_R03C01Meth`, `201332340172_R03C01detP`, 
                `201414140063_R08C01UnMeth`, `201414140063_R08C01Meth`, `201414140063_R08C01detP`
                )

write_csv(SampleMethAndDetP, path = "/home/qianhui/DNAme/Process_decidual/RDSfiles/SampleMethAndDetP.csv")

```



