---
title: "Part5_draw Sample Correlation"
author: "Qianhui"
date: "18/01/2019"
output: html_document
---

This document is mainly add to part5 of the GEO data set analysis, draw a sample correlation plot.

```{r setup, include=FALSE}

knitr::opts_chunk$set(fig.align = "center", error = TRUE, echo = TRUE) # fig.width = 7, 

```

# 1. load data and packages
```{r}
library(tidyverse)
library(ggpubr)
library(ggbeeswarm)
library(magrittr)
library(factoextra)
library(Hmisc)
library(corrplot)
library(doParallel)
library(FactoMineR)

# load data residuals
# load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/allSamplesResiduals_ControlCorrected.rds")

# BM list after normalisation, but not corrected for batch across samples
NormBMlist <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/NormBMlist.rds")

## GEOmeta, GEO_phenotypes
load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_phenotypes_add10.RData")

# # PCA_Placenta_M, PCA_PlacentaT1_M, PCA_PlacentaTerm_M
load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/PCA_placenta_deciduals_allT1Term_BMval.RData")

# BM list after normalisation, but not corrected for batch across samples
NormBMlist <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/NormBMlist.rds")

CutOffRight <- quantile(PCA_Placenta_M$ind$coord[, 1], 0.75)+ 1.5*IQR(PCA_Placenta_M$ind$coord[, 1])
CutOffLeft <- quantile(PCA_Placenta_M$ind$coord[, 1], 0.25)- 1.5*IQR(PCA_Placenta_M$ind$coord[, 1])

CutOffRightNames <- PCA_Placenta_M$ind$coord[, 1][PCA_Placenta_M$ind$coord[, 1]>CutOffRight] %>% sort() %>% names
CutOffLeftNames <- PCA_Placenta_M$ind$coord[, 1][PCA_Placenta_M$ind$coord[, 1]<CutOffLeft] %>% sort()%>% names

```


# 2. correlation analysis

## use `Hmisc` package to calculate correlation.
```{r eval=FALSE}
registerDoParallel(cores = 10)
# res.dist <- get_dist(t(Residuals), stand = TRUE, method = "pearson")
# fviz_dist(res.dist, gradient = list(low = "#00AFBB", mid = "white", high = "#FC4E07"))
Residuals <- NormBMlist$NormBAll

res2 <- rcorr(Residuals)

# ++++++++++++++++++++++++++++
# flattenCorrMatrix
# ++++++++++++++++++++++++++++
# cormat : matrix of the correlation coefficients
# pmat : matrix of the correlation p-values
flattenCorrMatrix <- function(cormat, pmat) {
  ut <- upper.tri(cormat)
  data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut],
    p = pmat[ut]
  )
}

CorDF <- flattenCorrMatrix(res2$r, res2$P)

```


## subset values for T1 and term samples, and do correlation calculation
```{r}
# table(colnames(Residuals) %in% GEO_phenotypes$Sample_name)
# Matched_pd <- GEO_phenotypes[match(colnames(Residuals), GEO_phenotypes$Sample_name),]

table(colnames(NormBMlist$NormBAll) %in% NormBMlist$phenoDataAll$Sample_name)
Matched_pd <- NormBMlist$phenoDataAll
Matched_pd$Outlier <- ifelse(Matched_pd$Additional_Info%in%"Outlier"|Matched_pd$Sample_name%in%c("GSM1702177_7970368142_R05C02", "GSM1947213_6008581028_R01C01"),
                             "Outlier", "Standard")
  
# T1
PhenodataPlacentaT1 <- Matched_pd[Matched_pd$Sample%in%"Placenta" & Matched_pd$Trimester%in%"First",]
# Placenta_Mnorm_T1 <-  Residuals[,colnames(Residuals)%in%PhenodataPlacentaT1$Sample_name]
Placenta_Mnorm_T1 <-  NormBMlist$NormMAll[,colnames(NormBMlist$NormMAll)%in%PhenodataPlacentaT1$Sample_name]

## correct batch for T1 placentas
batch <- factor(PhenodataPlacentaT1$Study)
modcombat <- model.matrix(~Outlier, data = PhenodataPlacentaT1)

Placenta_Mnorm_T1_corrected <- sva::ComBat(dat = Placenta_Mnorm_T1,
                                batch = batch, mod = modcombat,
                                par.prior = TRUE, prior.plots=FALSE)

# Placenta_Mnorm_T1_corrected <- Placenta_Mnorm_T1
res_T1 <- cor(Placenta_Mnorm_T1_corrected)
# CorDF_T1 <- flattenCorrMatrix(res_T1$r, res_T1$P) %>% 
#             group_by(row) %>% summarise(corMean=mean(cor))

CorDF_T1 <- res_T1 %>% rowMeans() %>% as.data.frame() %>% rownames_to_column() %>% 
            `colnames<-`(c("SampleNames", "MeanCor")) 

tiff(file = "/home/qianhui/DNAme/Process_decidual/figures/CorrelationPlot_T1_GEOPlacentaSamples.tiff", 
     width = 17, height = 12, units="cm",  res = 300)
corrplot(cor(Placenta_Mnorm_T1_corrected), diag = FALSE, order = "FPC",
         tl.pos = "td", tl.cex = 0.5, method = "color", type = "upper")
dev.off()

corrplot(cor(Placenta_Mnorm_T1_corrected), diag = FALSE, order = "FPC",
         tl.pos = "td", tl.cex = 0.5, method = "color", type = "upper")


# second
PhenodataPlacentaSecond <- Matched_pd[Matched_pd$Sample%in%"Placenta" &Matched_pd$Trimester%in%"Second",] 
Placenta_Mnorm_Second <-  NormBMlist$NormMAll[,colnames(NormBMlist$NormMAll)%in%PhenodataPlacentaSecond$Sample_name]

## correct batch for Term placentas
# batch <- factor(PhenodataPlacentaSecond$Study)
# modcombat <- model.matrix(~Outlier, data = PhenodataPlacentaSecond)
# 
# Placenta_Mnorm_Second_corrected <- sva::ComBat(dat = Placenta_Mnorm_Second,
#                                 batch = batch, mod = modcombat,
#                                 par.prior = TRUE, prior.plots=FALSE)

Placenta_Mnorm_Second_corrected <- Placenta_Mnorm_Second
res_T2 <- cor(Placenta_Mnorm_Second_corrected)

CorDF_T2 <- res_T2 %>% rowMeans() %>% as.data.frame() %>% rownames_to_column() %>% 
            `colnames<-`(c("SampleNames", "MeanCor")) 

corrplot(cor(Placenta_Mnorm_Second_corrected), diag = FALSE, order = "FPC",
         tl.pos = "td", tl.cex = 0.5, method = "color", type = "upper")


# Term
PhenodataPlacentaTerm <- Matched_pd[Matched_pd$Sample%in%"Placenta" &Matched_pd$Trimester%in%"Term",] 
# Placenta_Mnorm_Term <-  Residuals[,colnames(Residuals)%in%PhenodataPlacentaTerm$Sample_name]
Placenta_Mnorm_Term <-  NormBMlist$NormMAll[,colnames(NormBMlist$NormMAll)%in%PhenodataPlacentaTerm$Sample_name]

## correct batch for Term placentas
batch <- factor(PhenodataPlacentaTerm$Study)
modcombat <- model.matrix(~Outlier, data = PhenodataPlacentaTerm)

Placenta_Mnorm_Term_corrected <- sva::ComBat(dat = Placenta_Mnorm_Term,
                                batch = batch, mod = modcombat,
                                par.prior = TRUE, prior.plots=FALSE)

# Placenta_Mnorm_Term_corrected <- Placenta_Mnorm_Term
res_Term <- cor(Placenta_Mnorm_Term_corrected)

# CorDF_Term
CorDF_Term <- res_Term %>% rowMeans() %>% as.data.frame() %>% rownames_to_column() %>% 
            `colnames<-`(c("SampleNames", "MeanCor"))

tiff(file = "/home/qianhui/DNAme/Process_decidual/figures/CorrelationPlot_Term_GEOPlacentaSamples.tiff", 
     width = 17, height = 12, units="cm",  res = 300)
corrplot(cor(Placenta_Mnorm_Term_corrected), diag = FALSE, order = "FPC",
         tl.pos = "td", tl.cex = 0.5, method = "color", type = "upper")
dev.off()

corrplot(cor(Placenta_Mnorm_Term_corrected), diag = FALSE, order = "FPC",
         tl.pos = "td", tl.cex = 0.5, method = "color", type = "upper")

# draw boxplot
CorDFBoxplot <- base::rbind(CorDF_T1, CorDF_T2, CorDF_Term) %>% 
                inset('Trimeter', value=c(rep('First', nrow(CorDF_T1)), 
                                          rep('Second', nrow(CorDF_T2)), 
                                          rep('Term', nrow(CorDF_Term)))) %>% 
                inset('Outlier', value=c(PhenodataPlacentaT1$Outlier, 
                                         PhenodataPlacentaSecond$Outlier,
                                         PhenodataPlacentaTerm$Outlier))

# CorDFBoxplot <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/CorDFBoxplot.rds")

CorBoxplot <- CorDFBoxplot %>% 
  ggplot(aes(x=Trimeter, y=MeanCor))+
  geom_boxplot(outlier.shape = NA)+
  # geom_dotplot(binaxis = "y", stackdir='center', dotsize=1)
  geom_beeswarm(aes(colour = Outlier), alpha=0.7, cex=0.8, priority = "density")+
  scale_color_brewer(palette = "Dark2", labels=c("Outlier"="Mixed", "Standard"="Pure"))+
  labs(y="Correlation", colour="Placenta")+
  # scale_x_discrete(expand = expand_scale(mult = 2))+
  theme(text = element_text(size=9),
        axis.text.x= element_text(size=9, colour = "black"),
        legend.title=element_text(size=9),
        legend.text=element_text(size=9),
        # axis.ticks.x =  = unit(1.5, "cm"),
        legend.position="right")

CorBoxplot

tiff(file = "/home/qianhui/DNAme/Process_decidual/figures/CorrelationBoxplot_T1Term_GEOPlacentaSamples.tiff", 
     width = 20, height = 15, units="cm",  res = 300)
theme_set(theme_pubr())
CorBoxplot
dev.off()

save(Placenta_Mnorm_T1_corrected, Placenta_Mnorm_Term_corrected,
     file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/Placenta_Mnorm_T1Term_corrected_Mval.RData")

# saveRDS(CorDFBoxplot, file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/CorDFBoxplot.rds")
saveRDS(CorBoxplot, file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/Placenta_Mnorm_T1Term_CorBoxplot.rds")



# check the low correlation samples
## T2
lowCut_second <- quantile(CorDFBoxplot[CorDFBoxplot$Trimeter%in%"Second",]$MeanCor, 0.25)- 1.5*IQR(CorDFBoxplot[CorDFBoxplot$Trimeter%in%"Second",]$MeanCor)

CorDFBoxplot_SecondLow <- CorDFBoxplot[CorDFBoxplot$Trimeter%in%"Second" & CorDFBoxplot$MeanCor<lowCut_second,]

table(CorDFBoxplot_SecondLow$SampleNames%in%CutOffRightNames)
table(CorDFBoxplot_SecondLow$SampleNames%in%CutOffLeftNames)

## Term
lowCut_term <- quantile(CorDFBoxplot[CorDFBoxplot$Trimeter%in%"Term",]$MeanCor, 0.25)- 1.5*IQR(CorDFBoxplot[CorDFBoxplot$Trimeter%in%"Term",]$MeanCor)

CorDFBoxplot_TermLow <- CorDFBoxplot[CorDFBoxplot$Trimeter%in%"Term" & CorDFBoxplot$MeanCor<lowCut_term,]

table(CorDFBoxplot_TermLow$SampleNames%in%CutOffRightNames)
table(CorDFBoxplot_TermLow$SampleNames%in%CutOffLeftNames)

```


## use `corrplot` to draw correlation plot
```{r eval=FALSE}

tiff(file = "/home/qianhui/DNAme/Process_decidual/figures/Beta_density_ggplot_551.tiff", 
     width = 17, height = 12, units="cm",  res = 300)
corrplot(cor(Placenta_Mnorm_Term_corrected), diag = FALSE, order = "FPC",
         tl.pos = "td", tl.cex = 0.5, method = "color", type = "upper")
dev.off()

```


# plot low correlation samples (term) in PCA plot
```{r}
PCA551 <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/figures/PCA408df.rds")

PCA551_adddLowCor  <- PCA551 %>% 
  mutate(LowCor=ifelse(PCA551$SampleNames%in%CorDFBoxplot_TermLow$SampleNames, "LowCor", "Others"))

PCA551plot <- PCA551_adddLowCor %>%
  ggplot(aes(x, y)) + 
  # geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  geom_point(aes(shape = Tissue, col=LowCor), alpha = 1, size = 2)+ 
  # scale_color_manual(name="Tissue", values = c("Amnion"="#000000", "Chorion"="#BD0026",
  #                                              "Decidua"="#984EA3", "Maternal whole blood"="#999999",
  #                                              "Placenta"="#D95F02", "Impure placenta"="#1B9E77",
  #                                              "Umbilical cord blood"="#F781BF"))+
  # scale_shape_manual(values=c(0,1,5,2))+
  labs(x="PC1 (25.35%)", y="PC2 (10.20%)")+
  guides(color=guide_legend(nrow = 3), shape=guide_legend(nrow = 2)) +
  # stat_ellipse(aes(x, y, col=Tissue0), type = "t") +
  # stat_ellipse(type = "t")+ #type = "norm", linetype = 2
  geom_vline(aes(xintercept=quantile(PCA_Placenta_M$ind$coord[, 1], 0.75)+ 1.5*IQR(PCA_Placenta_M$ind$coord[, 1])),
             linetype=4, colour="black")+
  geom_vline(aes(xintercept=60), linetype=4, colour="red")+
  # geom_vline(aes(xintercept=quantile(PCA_Placenta_M$ind$coord[, 1], 0.25)- 1.5*IQR(PCA_Placenta_M$ind$coord[, 1])),
  #            linetype=4, colour="black")+
  geom_text(aes(x=155 , y=-600, label="Q3+1.5*IQR"), vjust=-0.4, hjust=0, size=3) + #angle=90,, "Q3+3*IQR")
  # geom_text(aes(x=-270 , y=-600, label="Q1-1.5*IQR"), vjust=-0.4, hjust=0, size=2) + #angle=90,, "Q3+3*IQR")
  # geom_text(aes(label=ifelse(LowCor=="LowCor",as.character(SampleNames),'')),hjust=0,vjust=0)+
  theme(text = element_text(size=9),
        legend.title=element_text(size=9),
        legend.text=element_text(size=9),
        axis.text.x =element_text(size=9, colour = "black"),
        axis.text.y =element_text(size=9, colour = "black"),
        legend.position="top")

```


# plot beta values for low correlation samples (term) 
```{r}

placenta_beta_dim1Top2perc.df_Term <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/placenta_beta_dim1Top2perc.df_Term.rds")

CorDFBoxplot_TermLow_select <- CorDFBoxplot_TermLow %>% 
  mutate(NameOutliers =  SampleNames) %>% 
  dplyr::select(SampleNames, NameOutliers)

placenta_beta_dim1Top2perc.df_Term_addCor  <- placenta_beta_dim1Top2perc.df_Term %>% 
  left_join(CorDFBoxplot_TermLow_select, by=c("Sample_name"="SampleNames"))

placenta_beta_dim1Top2perc.df_Term_addCor$NameOutliers[is.na(placenta_beta_dim1Top2perc.df_Term_addCor$NameOutliers)] <- "HighCor"
  

LowCor_Term <- placenta_beta_dim1Top2perc.df_Term_addCor %>% 
  ggplot(aes(x=NameOutliers, y=value, colour=Outlier_Term))+
  # geom_boxplot()+
  geom_violin()+
  # scale_x_discrete(labels=c("Outlier"="Outliers", "Standard"="Other Samples"))+
  labs(x="", y="Beta values")+
  stat_compare_means(label = "p.signif", method = "t.test",
                     ref.group = "GSM1931578_9296930098_R06C01") + #ref.group = ".all."
  geom_hline(aes(yintercept=0.5),
             linetype=4, colour="black")+
  theme(axis.text.y = element_text(size=12, colour ="black"),
        axis.text.x = element_text(size=12, colour ="black", angle = 90, hjust = 1),
        axis.title=element_text(size=12, colour ="black"),#,face="bold"
        text = element_text(size=12, colour ="black"))

LowCor_Term

MeanBeta <- placenta_beta_dim1Top2perc.df_Term_addCor %>% 
  group_by(NameOutliers, Outlier_Term) %>% 
  summarise(mean=mean(value)) %>% 
  dplyr::filter(abs(mean-0.3734358)>0.2)

placenta_beta_dim1Top2perc.df_Term_addCor %>% 
  group_by(NameOutliers, Outlier_Term) %>% 
  summarise(mean=mean(value)) %>% arrange(mean)

t <- placenta_beta_dim1Top2perc.df_Term_addCor %>% 
  group_by(NameOutliers, Outlier_Term, Name) %>% summarise(mean= mean(value)) %>% 
  dcast(Name~NameOutliers)


# use unique featuers (6029 probes in total)
FeatuerToAdd <- placenta_beta_dim1Top2perc.df_Term_addCor %>% dplyr::select(Sample_name, Outlier_Term,NameOutliers) %>% unique()

tDiff <- apply(t[,-1], 2, function(x){x - t$HighCor}) %>% as.data.frame() %>% cbind(Name=t$Name) %>%
  melt() %>% `colnames<-`(c("Name", "SampleName", "Beta")) %>% left_join(FeatuerToAdd, by =c("SampleName"="Sample_name"))

tDiff %>% ggplot(aes(x=NameOutliers, y=Beta, colour=Outlier_Term))+geom_violin()+ 
  geom_hline(yintercept = c(-0.2, 0.2))+
  theme(axis.text.y = element_text(size=12, colour ="black"),
        axis.text.x = element_text(size=12, colour ="black", angle = 90, hjust = 1),
        axis.title=element_text(size=12, colour ="black"),#,face="bold"
        text = element_text(size=12, colour ="black"))

tDiff %>% ggplot(aes(x=NameOutliers, y=Beta, colour=Outlier_Term))+geom_boxplot()+ 
  geom_hline(yintercept = c(-0.2, 0.2))+
  theme(axis.text.y = element_text(size=12, colour ="black"),
        axis.text.x = element_text(size=12, colour ="black", angle = 90, hjust = 1),
        axis.title=element_text(size=12, colour ="black"),#,face="bold"
        text = element_text(size=12, colour ="black"))

tDiff$NameOutliers[is.na(tDiff$NameOutliers)] <- "Pure"

tDiff0.2Cut <- tDiff[tDiff$Beta>0.2,]

# library(ggsignif)
tDiff0.2Cut %>% ggplot(aes(x=NameOutliers, fill=Outlier_Term))+
  geom_bar(aes(y = (..count..)/6029))+
  # geom_signif()+
  # geom_hline(yintercept = c(-0.2, 0.2))+
  theme(axis.text.y = element_text(size=12, colour ="black"),
        axis.text.x = element_text(size=12, colour ="black", angle = 90, hjust = 1),
        axis.title=element_text(size=12, colour ="black"),#,face="bold"
        text = element_text(size=12, colour ="black"))


```


# (First) plot low correlation samples  in PCA plot
```{r}

placenta_beta_dim1Top2perc.df_T1 <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/placenta_beta_dim1Top2perc.df_T1.rds")
  

LowCor_T1 <- placenta_beta_dim1Top2perc.df_T1 %>% 
  ggplot(aes(x=Outlier_T1, y=value))+
  # geom_boxplot()+
  geom_violin()+
  # scale_x_discrete(labels=c("Outlier"="Outliers", "Standard"="Other Samples"))+
  labs(x="", y="Beta values")+
  stat_compare_means(label = "p.signif", method = "t.test",
                     ref.group = "GSM1931578_9296930098_R06C01") + #ref.group = ".all."
  geom_hline(aes(yintercept=0.5),
             linetype=4, colour="black")+
  theme(axis.text.y = element_text(size=12, colour ="black"),
        axis.text.x = element_text(size=12, colour ="black", angle = 90, hjust = 1),
        axis.title=element_text(size=12, colour ="black"),#,face="bold"
        text = element_text(size=12, colour ="black"))

LowCor_T1

MeanBeta_T1 <- placenta_beta_dim1Top2perc.df_T1 %>% 
  group_by(Outlier_T1) %>% 
  summarise(mean=mean(value)) %>% 
  dplyr::filter(abs(mean-0.3952628)>0.2)

placenta_beta_dim1Top2perc.df_T1 %>% 
  group_by(Outlier_T1) %>% 
  summarise(mean=mean(value)) %>% arrange(mean)

t_T1 <- placenta_beta_dim1Top2perc.df_T1 %>% 
  group_by(Outlier_T1, Name) %>% summarise(mean= mean(value)) %>% 
  dcast(Name~Outlier_T1)


# use unique featuers (6029 probes in total)
FeatuerToAdd_T1 <- placenta_beta_dim1Top2perc.df_T1 %>% 
  dplyr::select(Sample_name, Outlier_T1) %>% unique()

tDiff_T1 <- apply(t_T1[,-1], 2, function(x){x - t_T1$Pure}) %>% as.data.frame() %>% 
  cbind(Name=t_T1$Name) %>%
  melt() %>% `colnames<-`(c("Name", "SampleName", "Beta")) %>% 
  left_join(FeatuerToAdd_T1, by =c("SampleName"="Outlier_T1"))

tDiff_T1 %>% ggplot(aes(x=SampleName, y=Beta))+geom_violin()+ 
  geom_hline(yintercept = c(-0.2, 0.2))+
  theme(axis.text.y = element_text(size=12, colour ="black"),
        axis.text.x = element_text(size=12, colour ="black", angle = 90, hjust = 1),
        axis.title=element_text(size=12, colour ="black"),#,face="bold"
        text = element_text(size=12, colour ="black"))

tDiff_T1 %>% ggplot(aes(x=SampleName, y=Beta))+geom_boxplot()+ 
  geom_hline(yintercept = c(-0.2, 0.2))+
  theme(axis.text.y = element_text(size=12, colour ="black"),
        axis.text.x = element_text(size=12, colour ="black", angle = 90, hjust = 1),
        axis.title=element_text(size=12, colour ="black"),#,face="bold"
        text = element_text(size=12, colour ="black"))

tDiff_T10.2Cut <- tDiff_T1[tDiff_T1$Beta>0.2,]

# library(ggsignif)
tDiff_T10.2Cut %>% ggplot(aes(x=SampleName))+
  # geom_bar(aes(y = (..count..)/6029))+
  geom_bar()+
  # geom_signif()+
  # geom_hline(yintercept = c(-0.2, 0.2))+
  theme(axis.text.y = element_text(size=12, colour ="black"),
        axis.text.x = element_text(size=12, colour ="black", angle = 90, hjust = 1),
        axis.title=element_text(size=12, colour ="black"),#,face="bold"
        text = element_text(size=12, colour ="black"))



```



# use PCLDA to group samples (placenta vs non-placenta)
```{r}
PCA551 <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/figures/PCA408df.rds")

placenta_beta_dim1Top2perc.df_T1 <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/placenta_beta_dim1Top2perc.df_T1.rds")

placenta_beta_dim1Top2perc.df_T2 <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/placenta_beta_dim1Top2perc.df_T2.rds")

placenta_beta_dim1Top2perc.df_Term <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/placenta_beta_dim1Top2perc.df_Term.rds")

PCA551$TwoGroup <- ifelse(PCA551$Tissue0%in%"Placenta", "Placenta", "NotPlacenta")
  
library(MASS)
fit <- lda(TwoGroup ~ x+y, data=PCA551, 
   na.action="na.omit", CV=TRUE)
fit # show results


# Assess the accuracy of the prediction
# percent correct for each category of G
ct <- table(PCA551$TwoGroup, fit$class)
diag(prop.table(ct, 1))
# total percent correct
sum(diag(prop.table(ct)))


# get percentage for classification
PercClass <- fit$posterior %>% as.data.frame() %>% cbind(tibble(ldaClass=fit$class)) %>% 
  cbind(PCA551) %>% arrange(Placenta) 

OutlierAnn <- placenta_beta_dim1Top2perc.df_T1 %>% dplyr::select(Sample_name, Outlier=Outlier_T1) %>% unique() %>% 
  rbind(dplyr::select(placenta_beta_dim1Top2perc.df_T2, Sample_name, Outlier) %>% unique()) %>% 
  rbind(dplyr::select(placenta_beta_dim1Top2perc.df_Term, Sample_name, Outlier=Outlier_Term) %>% unique()) %>% 
  `colnames<-`(c("SampleNames", "OutlierEach"))

PercClass %<>% left_join(OutlierAnn, by="SampleNames")


PercClass %>% ggplot(aes(x=Tissue0, y=Placenta))+ geom_boxplot()+ylim(0,1.5)

PercClass[PercClass$Tissue0%in%"Placenta",] %>% ggplot(aes(x=OutlierEach, y=Placenta))+geom_bar(stat = "identity")+
  ylim(0,1.2)+facet_wrap(~Trimester, scales = "free")+
  stat_compare_means(label = "p.signif", method = "t.test",
                     ref.group = ".all.")


# output file for the placenta percentage
PercClassOutPut <- PercClass %>% dplyr::select(SampleNames, TissueTypes=Tissue0, PC1=x, PC2=y, #NotPlacenta, 
                                               Trimester, FetalSex, Study, Outlier=OutlierEach, PlacentaPercentage=Placenta) %>% 
  mutate(Outlier=case_when(is.na(Outlier) ~ "NotPlacenta",
                           (!is.na(Outlier)) ~ Outlier)) %>% arrange(PlacentaPercentage)
  
saveRDS(PercClassOutPut, file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/PCALDAresult_PercClassOutPut.rds")

write_csv(PercClassOutPut, path = "/home/qianhui/DNAme/Process_decidual/RDSfiles/PCALDAresult_PercClassOutPut.csv")

```

# A summary:
  Other samples (except for outliers) that have low correlatin with pure placenta samples could be due to:
    - tissue collected adjacent to cord insertion
    - maternal smoking
    - maternal nightshift work
    - maternal age
    - after term birth (>37 week's gestation)
   According to PCA, PC1 is dominated by tissue impurity,  



# Use mclust for unsupervised clustering for all samples to seperate pure and impure placenta samples

```{r}
library(mclust)
## GEOmeta, GEO_phenotypes
load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_phenotypes_add10.RData")
# # PCA_Placenta_M, PCA_PlacentaT1_M, PCA_PlacentaTerm_M
# load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/PCA_placenta_deciduals_allT1Term.RData")
load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/PCA_placenta_deciduals_allT1Term_BMval.RData")

NormBMlist <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/NormBMlist.rds")

# all saples PCA
Residuals <- NormBMlist$NormMAll
table(colnames(Residuals) %in% GEO_phenotypes$Sample_name)

Matched_pd <- GEO_phenotypes[match(colnames(Residuals), GEO_phenotypes$Sample_name),]

df <- PCA_Placenta_M$ind$coord %>% as.data.frame() %>% rownames_to_column(var="Sample_name") %>% 
  left_join(Matched_pd, by="Sample_name")
rownames(df) <- df$Sample_name

a1 <- Mclust(df[,c("Dim.1","Dim.2")],2) #for 2 groups

a1 <- Mclust(df[,c("Dim.1")],2) #for 2 groups

table(a1$classification,df$Sample)
with(df,plot(Dim.2 ~ Dim.1,pch=as.numeric(as.factor(Sample)),col=a1$classification))
with(df,legend("topright",levels(as.factor(Sample)),pch=1:6))

PercClassOutPut <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/PCALDAresult_PercClassOutPut.rds")

PercClassOutPutMclust <- a1$z %>% as.data.frame() %>% rownames_to_column(var="Sample_name") %>% 
  left_join(PercClassOutPut, by=c("Sample_name"="SampleNames")) %>% 
  dplyr::select(Sample_name, PlacentaPercentageMclust=V2,TissueTypes:PlacentaPercentage) %>%
  arrange(PlacentaPercentageMclust)

saveRDS(PercClassOutPutMclust, file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/PercClassOutPutMclust.rds")

write_csv(PercClassOutPutMclust, path = "/home/qianhui/DNAme/Process_decidual/RDSfiles/PercClassOutPutMclust.csv")

```


```{r}
# PCA plot of corrected T1 and Term placenta Mvals
# source("~/DNAme/Process_decidual/ggplotPCAFUN.R")
# 
# PCA_Placenta_M_T1 <- FactoMineR::PCA(t(Placenta_Mnorm_T1_corrected))
# 
# ggplotPCA(PCA_Placenta_M = PCA_Placenta_M_T1, 
#           Matched_pd = PhenodataPlacentaT1, 
#           value = "CorrectedM_T1")
# 
# PCA_Placenta_M_Term <- FactoMineR::PCA(t(Placenta_Mnorm_Term_corrected))
# 
# ggplotPCA(PCA_Placenta_M = PCA_Placenta_M_Term, 
#           Matched_pd = PhenodataPlacentaTerm, 
#           value = "CorrectedM_Term")

# residual term
# Placenta_Mnorm_TermPCA_residual <- FactoMineR::PCA(t(Placenta_Mnorm_Term))
# 
# ggplotPCA(PCA_Placenta_M = Placenta_Mnorm_TermPCA_residual, 
#           Matched_pd = PhenodataPlacentaTerm,
#           value = "CorrectedM_residual_Term")  

```



