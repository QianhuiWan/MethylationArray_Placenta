---
title: "technical report (mainly 450k data, 15 GEO data sets used)"
author: "Qianhui"
date: "29/11/2018"
output: html_document
---

This document is mainly for part5 of the GEO data set analysis, that is the normalisation and batch correction step.

Cord blood only have one sample.

```{r setup, include=FALSE}

knitr::opts_chunk$set(fig.align = "center", error = TRUE, echo = TRUE) # fig.width = 7, 

```


# 1. load data and packages
```{r package, warning=FALSE, message=FALSE, echo=TRUE, results='hide'}

library(tidyverse)
library(readxl)
library(minfi)
library(magrittr)
library(tibble)
library(data.table)
library(limma)
library(ewastools)
library(ENmix)
library(wateRmelon)
library(FactoMineR)
library(WGCNA)
library(impute)
library(ChAMP)
library(sva)
library(quantro)
library(doParallel)
library(ggplot2)
library(RColorBrewer)
pal <- brewer.pal(8, "Dark2")

# GEOmeta, GEO_phenotypes
load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_phenotypes_add10.RData")

# Msets
# Mset_450k_normalPlacenta_v1, Mset_EPIC_normalPlacenta, Mset_EPIC_normalPlacenta_ourStudy, 
# Mset_450k_Amnion, Mset_EPIC_Amnion, # Mset_450k_Chorion, Mset_EPIC_Chorion,
# Mset_450k_Decidua, Mset_EPIC_Decidua, # Mset_450k_MaternalBlood_v1, Mset_450k_mesenchyme,
# Mset_450k_trophoblast, Mset_450k_UC, Mset_450k_UCB,
load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/MsetsOf9TissueTypes.RData")

# Join.df_v2, GEO_phenotypes_joinedSamples, MDS_joinedSamples
load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_joinedSamples551_Beta_MDS.RData")

# annotation needed for using functions
ann450k <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/ann450k_GEO15sets.rds")
annEPIC <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/annEPIC_GEO15sets.rds")

```


# 2. Nomalisation

There are many tissue types for normal tissue samples around placenta, such as cord blood, chorionic plate and so on. I used modified BMIQ method to normalise different tissue separately. 


** When I used GSE74738 as gold standard, the batches were not corrected very well; **
** Then I try to use GSE75248 as gold standard because this dataset have 174 placental samples which is the biggest dataset for placenta sampels. However, the result of this calibration is even worse than using GSE74738 as gold standard**

There are 9 tissue types (we choose tissue types located near placenta) in total from GEO.

## A) Function for and normalisation using BMIQ_Horvath.R

### Source Horvath's modified BMIQ functions, the function that need to be called in `NormFUN`, 

* I source the code for modified BMIQ normalisation, the `BMIQcalibration` function will be used in the `NormFUN` chunk. 

```{r BMIQ_Horvath}

# `BMIQcalibration` function in `BMIQ_Horvath.R`
source(file = "~/DNAme/Process_decidual/Rcodes/BMIQ_Horvath.R")

```


### Write function `CalibrateFUN`

We first need to normalise with BMIQ and then calibrate data with `BMIQ_calibration` use my `CalibrateFUN`

#### normalise Msets with BMIQ method
```{r NormCaliFUN}
  # annotation: ann450k or annEPIC, need to be a DataFrame, annataion from the illumina annotation package
registerDoParallel(cores = 10)
  
  # do BMIQ normalisation for all Msets
  Msets <- c('Mset_450k_normalPlacenta_v1', 'Mset_EPIC_normalPlacenta', 'Mset_EPIC_normalPlacenta_ourStudy',
           'Mset_450k_Amnion', #'Mset_EPIC_Amnion',
           'Mset_450k_Chorion', #'Mset_EPIC_Chorion',
           'Mset_450k_Decidua', 'Mset_EPIC_Decidua', 
           'Mset_450k_MaternalBlood_v1', #'Mset_450k_mesenchyme','Mset_450k_trophoblast', 
           # 'Mset_450k_UC', 
           'Mset_450k_UCB')
  
  ## normalise beta value for this tissue type
  ListToJoin <- list()
  
  # get BMIQ normalised beta values
  for(i in Msets){
  # get the object
  Mset <- get(i)
  
  # names for the list
  listElements <- paste0("normB", str_replace_all(i, "Mset", ""), ".df")

  # fill the list with beta values
  ListToJoin[[listElements]] <- wateRmelon::BMIQ(beta.v = Mset) %>% 
    as.data.frame() %>% rownames_to_column(var="Probe")
  
  }

  # left_join values form all samples
  Join_allNorm.df <- ListToJoin %>% purrr::reduce(left_join, by = "Probe")
  # omit na values
  Join_allNorm.df_v1 <- na.omit(Join_allNorm.df)
  # as matrix
  Join_allNorm.df_v2 <- Join_allNorm.df_v1 %>% remove_rownames() %>%
  column_to_rownames(var="Probe") %>% as.matrix() # 298179
  
  # phenotypes of all samples form all the tissue types
  phenotype_matched <- GEO_phenotypes[match(colnames(Join_allNorm.df_v2),GEO_phenotypes$Sample_name),]
  
  # M values
  Mnorm <- log2(Join_allNorm.df_v2/(1 - Join_allNorm.df_v2))
  Mnorm_v1 <- Mnorm[apply(Mnorm, 1, function(x) all(is.finite(x))), , drop=FALSE]
  
  # plot MDS
  ## MDS for M values
  MDS_norm551.M <- plotMDS(Mnorm_v1, top = nrow(Mnorm_v1), 
                           labels = phenotype_matched$Sample, gene.selection = "common")
  ## MDS for Beta values
  MDS_norm551.Beta <- plotMDS(Join_allNorm.df_v2, top = nrow(Join_allNorm.df_v2), 
                           labels = phenotype_matched$Sample, gene.selection = "common")

  # put into a list
  NormBMlist <- list(NormBAll=Join_allNorm.df_v2, NormMAll=Mnorm_v1, 
                     phenoDataAll=phenotype_matched, 
                     MDS_norm551.Beta=MDS_norm551.Beta, MDS_norm551.M=MDS_norm551.M)
  
  saveRDS(NormBMlist, file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/NormBMlist.rds")
  
```  
  

# 3. MDS plot using all data

## A) plot 9 separate plots for 9 different tissue types.

### Function `plotMDSFUN`

**Tissue argument in `plotMDSFUN` function could be: Placenta, Amnion, Chorion, Decidua, Maternal whole blood, placental mesenchyme, placental trophoblast, umbilical cord, Umbilical cord blood.**

```{r plotMDSFUN}
# phenoData: GEO_phenotypes, meta data for all samples
# Array: "450k" or "EPIC"

plotMDSFUN <- function(Normal_betaNorm, Tissue, PhenoData, ...){
  registerDoParallel(cores = 10)

  # get meta data
  GEO_phenotypes_Tissue <- PhenoData %>% 
  filter(str_detect(Sample, pattern=paste0("^", Tissue, "$")))
  
  # then get beta values for each tissue type
  Normal_betaNorm_forPlot <- Normal_betaNorm[,colnames(Normal_betaNorm)%in%GEO_phenotypes_Tissue$Sample_name, drop=FALSE]
  
  # plotMDS plots
  if(all(table(GEO_phenotypes_Tissue$Sample_name==colnames(Normal_betaNorm_forPlot)))){
      label <- GEO_phenotypes_Tissue$Trimester
  }else{
    print("Rownames of beta matrix were not matched with phenoData$Sample_name")
  }

  if(ncol(Normal_betaNorm_forPlot)>=3){
  par(mfrow=c(1,1), ...)
  plotMDS(Normal_betaNorm_forPlot, top=nrow(Normal_betaNorm_forPlot), 
          main=Tissue, labels= label, gene.selection="common") 
  }
  # labels= label, col= pal[factor(label)],

  # plot density plot anagin with other 96 samples 
  par(mfrow=c(1,1), cex=0.8, ...)
  densityPlot(Normal_betaNorm_forPlot, sampGroups = label, 
              main=Tissue, xlab = "Normalised Beta values")

}# end function

```


### Use function `plotMDSFUN`, plot 9 separate plots for 9 different tissue types.

```{r UseplotMDSFUN}

TissueBMvalInfo <- tibble(
  TissueTypes = c("Placenta", "Amnion", "Chorion", "Decidua",
                "Maternal whole blood",
                # "placental mesenchyme", 
                # "placental trophoblast", "umbilical cord", 
                "Umbilical cord blood")
)


# use plotMDSFUN function
for(i in TissueBMvalInfo$TissueTypes){
  
  plotMDSFUN(Normal_betaNorm = normCali_BMof9TissueTypes_CaliTogether$Beta, 
             Tissue = i, 
             PhenoData = normCali_BMof9TissueTypes_CaliTogether$BetaPhenoData)
}

```


## B) plot all values (408 samples) in one MDS plot

### `plotAll` function
```{r joinAllandPlotAll}
# value-- Beta or M
# TissueBMvalInfo -- a tibble containing BM names

plotAll <- function(BMvalue, GEO_phenotypes_joinedSamples){
  registerDoParallel(cores = 10)
  
  #plotMDS plots
  ## phenodata for these samples
  GEO_phenotypes_408 <- GEO_phenotypes_joinedSamples[match(colnames(BMvalue),
                                                               GEO_phenotypes_joinedSamples$Sample_name),]
  ## check names all in same order or not
  table(colnames(BMvalue)==GEO_phenotypes_408$Sample_name)

  ## plot MDS plot
  par(mfrow=c(1,1))
  MDS_norm408 <- plotMDS(BMvalue, top=nrow(BMvalue), labels= GEO_phenotypes_408$Sample,
                         gene.selection="common") 

  # plot density plot
  par(mfrow=c(1,1), cex=0.8)
  densityPlot(BMvalue, sampGroups = GEO_phenotypes_408$Sample, xlab = "Normalised Beta values")
  
  # return Join.df_v2, GEO_phenotypes_norm551 and MDS_norm551
  output_List <- list(JoinAll=BMvalue, phenoDataAll=GEO_phenotypes_408, MDSnorm408=MDS_norm408)
  return(output_List)
}

```


### use `plotAll` function
```{r USEplotAll}

MDSnormCali551_Beta <- plotAll(BMvalue = normCali_BMof9TissueTypes_CaliTogether$Beta,
                           GEO_phenotypes_joinedSamples = normCali_BMof9TissueTypes_CaliTogether$BetaPhenoData)

MDSnormCali551_M <- plotAll(BMvalue = normCali_BMof9TissueTypes_CaliTogether$M, 
                        GEO_phenotypes_joinedSamples = normCali_BMof9TissueTypes_CaliTogether$BetaPhenoData)


save(MDSnormCali551_Beta, MDSnormCali551_M,
     file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_joinedSamplesNormalisedCalibrated551_BetaM_MDS.RData")

```


## C) MDS for all 551 samples use `ggplot`

### function for plot MDS with ggplot -- `ggplotMDS` function
```{r ggplotMDS}

library(RColorBrewer)
colorFun <- colorRampPalette(brewer.pal(9, "Set1"))
pal2 <- colorFun(13)

# set up df for ggplot
## check sample orders were the same or not
table(colnames(MDSnormCali551_Beta$JoinAll)==MDSnormCali551_Beta$phenoDataAll$Sample_name)
table(colnames(MDSnormCali551_M$JoinAll)==MDSnormCali551_M$phenoDataAll$Sample_name)

# ggplotMDS function
## value -- Beta or M
ggplotMDS <- function(MDS_norm551, GEO_phenotypes_norm551, value){
  
  new_plotDF <- data.frame(MDS_norm551$x, 
      MDS_norm551$y,
      GA = GEO_phenotypes_norm551$Gestation,
      FetalSex= GEO_phenotypes_norm551$Fetal_Sex,
      Tissue=str_replace_all(GEO_phenotypes_norm551$Sample, c(
                                        "placental"="Placental",
                                        "umbilical"="Umbilical")),
      Trimester=GEO_phenotypes_norm551$Trimester,
      Study=GEO_phenotypes_norm551$Study,
      Outlier=ifelse(GEO_phenotypes_norm551$Additional_Info%in%"Outlier", "Outlier", "Standard"),
      ArrayType=GEO_phenotypes_norm551$ArrayType
    
  )

  colnames(new_plotDF) <- c("x", "y", "Gestational age", "FetalSex", "Tissue", "Trimester", "Study", "Outlier", "ArrayType")

  # Plot the new dataframe
  ## color to use
  namedPal2 <- pal2 %>% `names<-`(unique(new_plotDF$Tissue))
  TissueShape <- factor(new_plotDF$Tissue)

  MDSplot_norm551 <- new_plotDF %>%
    ggplot(aes(x, y)) + 
    geom_point(aes(shape = Study, col=Trimester), alpha = 1, size = 5)+ 
    # scale_color_manual(values = namedPal2)+
    scale_shape_manual(values=1:length(new_plotDF$Study))+
    labs(x="Dimension 1", y="Dimension 2")+
    theme(text = element_text(size=20))
    # axis.text.x = element_text(angle=90, hjust=1)) 


  # save the MDS plot as pdf:
  pdf(file = paste0("/home/qianhui/DNAme/Process_decidual/figures/MDSplot-Normalised", value, "_joinedGEOsamples408.pdf"), 
    width = 13, height = 7)

  theme_set(theme_bw())
  MDSplot_norm551
  dev.off()

  # save as tiff
  tiff(file = paste0("/home/qianhui/DNAme/Process_decidual/figures/MDSplot-Normalised", value, "_joinedGEOsamples408.tiff"), 
     width = 20,height = 15, units="cm",  res = 300)

  theme_set(theme_bw())
  MDSplot_norm551
  dev.off()
  
  # show the plot
  theme_set(theme_bw())
  MDSplot_norm551 %>% print()
  
  # return new_plotDF
  return(new_plotDF)
}

```


### use `ggplotMDS` function
```{r useggplotMDS}

# for MDSnormCali551_Beta
AllBetaMDSinfo <- ggplotMDS(MDS_norm551 = MDSnormCali551_Beta$MDSnorm551, 
          GEO_phenotypes_norm551 = MDSnormCali551_Beta$phenoDataAll, 
          value = "Beta")

AllBetaMDSinfo %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  # scale_color_manual(values = namedPal2)+
  scale_shape_manual(values=1:length(AllBetaMDSinfo$Study))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))


# for MDSnormCali551_M
AllMMDSinfo <- ggplotMDS(MDS_norm551 = MDSnormCali551_M$MDSnorm551, 
          GEO_phenotypes_norm551 = MDSnormCali551_M$phenoDataAll, 
          value = "M")

AllMMDSinfo %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  # scale_color_manual(values = namedPal2)+
  scale_shape_manual(values=1:length(AllMMDSinfo$Study))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))

```

* all data have been adjust for batch effects. but the batch effects seems still obvious, probably need to use ComBat(sva) to adjust for batch.


# 4. Use Combat to adjust batch

* I used the BMIQ normalisation data and then use Combat to correct for batch effects between studies.

## A) function `CombatFUN`
```{r CombatFUN}
# we use the BMIQ normalised data for the following function
NormBMlist <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/NormBMlist.rds")

## the `CombatFUN`
# MMat=NormBMlist$NormMAll
# phenotype=NormBMlist$phenoDataAll

CombatFUN <- function(MMat, phenotype){
  registerDoParallel(cores = 10)
  
  # # df including tissue informations
  # Tissue <- c("Placenta", "Amnion", "Chorion", "Decidua",
  #            "Maternal whole blood", "placental mesenchyme",
  #            "placental trophoblast", "umbilical cord", "Umbilical cord blood")

  # # add all normalised beta values to a list
  # for(tissue in Tissue){
  # # subset the beta values for one tissue type
  # ## one tissue type
  # sampleNamesForOneTissue <- phenotype[phenotype$Sample%in%tissue,]
  # BetaMat_1Tissue <- BetaMat[,colnames(BetaMat)%in%sampleNamesForOneTissue$Sample_name, drop=FALSE]
  # 
  # ## normalise beta value for this tissue type
  # ListToJoin <- list()
  # # names for the list
  # listElements <- c(paste0("normB", "_", str_replace_all(Tissue, " ", "_"), ".df"))
  # 
  # # fill the list with beta values
  # ListToJoin[[listElements]] <- BMIQ(beta = BetaMat_1Tissue) %>% 
  #                               as.data.frame() %>% rownames_to_column(var="Probe")
  # }
  # 
  # # left_join values form all samples
  # Join_allNorm.df <- ListToJoin %>% purrr::reduce(left_join, by = "Probe")
  # # omit na values
  # Join_allNorm.df_v1 <- na.omit(Join_allNorm.df)
  # # as matrix
  # Join_allNorm.df_v2 <- Join_allNorm.df_v1 %>% remove_rownames() %>% 
  # column_to_rownames(var="Probe") %>% as.matrix() # 298179
  
  # phenotype_matched <- phenotype[match(colnames(MMat),
  #                                      phenotype$Sample_name),]
  # 
  # 
  # # add all normalised beta values to a list
  # 
  # for(t in Tissue){
  # # subset the beta values for one tissue type
  # ## one tissue type
  # phenotype_matched_oneTissue <- phenotype_matched[phenotype_matched$Sample%in%t,]
  # MMatOneTissue <- MMat[,colnames(MMat)%in%phenotype_matched_oneTissue$Sample_name,drop=FALSE]
  # 
  # ListToJoin <- list()
  # # names for the list
  # listElements <- c(paste0("CorrectM", "_", str_replace_all(t, " ", "_"), ".df"))
  # phenotype_matched_oneTissue$Trimester[phenotype_matched_oneTissue$Trimester%in%NA] <- "unknown"
  # 
  # if(t=="Placenta"){
  #   
  #   ListToJoin[[listElements]] <- champ.runCombat(beta = MMatOneTissue, 
  #                                        pd = phenotype_matched_oneTissue, 
  #                                        variablename = "Trimester",
  #                                        batchname = "Study", 
  #                                        logitTrans = FALSE) %>%
  #                               as.data.frame() %>% rownames_to_column(var="Probe")}
  # 
  # batch1 <- factor(phenotype_matched_oneTissue$Study)
  # modcombat <- model.matrix(~ 1,
  #                           data = phenotype_matched_oneTissue)
  # 
  # # adjust bach effect for preprocessed mval using Combat function
  # placenta_Mval_combatAdjusted1 <- ComBat(dat = MMatOneTissue, batch = batch1, mod = modcombat, 
  #                                         par.prior = TRUE, prior.plots=TRUE)
  # 
  # # }else{
  # # # fill the list with combat corrected M values
  # # ListToJoin[[listElements]] <- champ.runCombat(beta = MMatOneTissue, 
  # #                                        pd = phenotype_matched_oneTissue, 
  # #                                        variablename = "Sample",
  # #                                        batchname = "Study", 
  # #                                        logitTrans = FALSE) %>%
  # #                               as.data.frame() %>% rownames_to_column(var="Probe")
  # # 
  # # }
  # 
  # }
  # 
  # # left_join values form all samples
  # Join_allCorrectedM.df <- ListToJoin %>% purrr::reduce(left_join, by = "Probe")
  # # omit na values
  # Join_allCorrectedM.df_v1 <- na.omit(Join_allCorrectedM.df)
  # # as matrix
  # Join_allCorrectedM.df_v2 <- Join_allCorrectedM.df_v1 %>% remove_rownames() %>%
  # column_to_rownames(var="Probe") %>% as.matrix() # 298179
  
  phenotype_matched <- phenotype[match(colnames(MMat),
                                       phenotype$Sample_name),]
  
  # phenotype_matched$group <- phenotype_matched$Sample
  # phenotype_matched$group[phenotype_matched$Sample%in%"Placenta"] <- paste0("Placenta",                                                     phenotype_matched$Trimester[phenotype_matched$Sample%in%"Placenta"])

  # ## use Combat to correct batch effects between studies
  # MMat_batchCorrected <- champ.runCombat(beta = MMat, 
  #                                        pd = phenotype_matched, 
  #                                        variablename = "group",
  #                                        batchname = "Study", 
  #                                        logitTrans = FALSE)
  
  ## use Combat from csv package
  batch1 <- factor(phenotype_matched$Study)
  Samples <- factor(phenotype_matched$Sample)
  trimester <- factor(phenotype_matched$Trimester)
  Outlier <- factor(ifelse(phenotype_matched$Additional_Info%in%"Outlier", "Outlier", "Standard"))
  
  modcombat <- model.matrix(~ Samples+trimester+Outlier)

  MMat_batchCorrected <- ComBat(dat = MMat[,colnames(MMat)%in%phenotype_matched$Sample_name], 
                                batch = batch1, mod = modcombat, par.prior = TRUE, prior.plots=FALSE)
  
  # return list containing beta and M values
  ## calculate Beta values
  BetaMat_batchCorrected <- 2^MMat_batchCorrected / (1+2^MMat_batchCorrected)

  # return beta and M values
  BM_List_combat <- list(Beta=BetaMat_batchCorrected, 
                         M=MMat_batchCorrected,
                         PhenoData=phenotype_matched)
  return(BM_List_combat)

}

```


## B) use `CombatFUN` to correct batch
```{r useCombatFUN}

# MDSnormCali551_M modified BMIQ calibrated data
BMall_combat <- CombatFUN(MMat = NormBMlist$NormMAll, 
                          phenotype = NormBMlist$phenoDataAll)

```


## C) MDS plot using batch corrected data
```{r plotMDSplots}

#plotMDS plots
## phenodata for these samples
## check names are in the same order
table(colnames(BMall_combat$Beta)==BMall_combat$PhenoData$Sample_name)

## plot MDS plot
par(mfrow=c(1,1))
MDS_normCorrect551.Beta <- plotMDS(BMall_combat$Beta, top=nrow(BMall_combat$Beta), 
                              labels= BMall_combat$PhenoData$Sample, gene.selection="common") 

par(mfrow=c(1,1))
MDS_normCorrect551.M <- plotMDS(BMall_combat$M, top=nrow(BMall_combat$M), 
                              labels= BMall_combat$PhenoData$Sample, gene.selection="common") 


AllMMDSinfo <- ggplotMDS(MDS_norm551 = MDS_normCorrect551.M, 
          GEO_phenotypes_norm551 = BMall_combat$PhenoData, 
          value = "correctedMv1")

  
save(BMall_combat, MDS_normCorrect551.Beta, MDS_normCorrect551.M, 
     file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/GEO_joinedSamples_NormBatchCorrect551_BetaM_MDS_OutlierConsidered.RData")

Mplacenta_combat <- BMall_combat$M[,BMall_combat$PhenoData$Sample%in%"Placenta"]
lebels <- BMall_combat$PhenoData[BMall_combat$PhenoData$Sample%in%"Placenta",]

plotMDS(Mplacenta_combat, top=nrow(Mplacenta_combat), labels = lebels$Sample, gene.selection = "common")

```


## D) use ggplot to plot MDS, use `ggplotMDS` function again
```{r useggplotMDSagain}
# for MDS_normCorrect551_Beta
AllBetaMDSinfo <- ggplotMDS(MDS_norm551 = MDS_normCorrect551.Beta, 
          GEO_phenotypes_norm551 = BMall_combat$PhenoData, 
          value = "correctedBeta")

AllBetaMDSinfo %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  # scale_color_manual(values = namedPal2)+
  scale_shape_manual(values=1:length(AllBetaMDSinfo$Study))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))

# for MDS_normCorrect551_M
AllMMDSinfo <- ggplotMDS(MDS_norm551 = MDS_normCorrect551.M, 
          GEO_phenotypes_norm551 = BMall_combat$PhenoData, 
          value = "correctedM")

AllMMDSinfo %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  # scale_color_manual(values = namedPal2)+
  scale_shape_manual(values=1:length(AllMMDSinfo$Study))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))

```



# 5. 1st and term samples, before and after batch correction

## A) Use MDS_norm551.M and MDS_norm551.beta objects in `NormBMlist` list: batch not corrected
```{r}

NormBMlist <- readRDS(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/NormBMlist.rds")

# MDS_norm551.M or NormBMlist$MDS_norm551.M
table(rownames(NormBMlist$MDS_norm551.M$distance.matrix)==NormBMlist$phenoDataAll$Sample_name)
MDSinfo_uncorrected <- ggplotMDS(MDS_norm551 = NormBMlist$MDS_norm551.M, 
                                 GEO_phenotypes_norm551 = NormBMlist$phenoDataAll, 
                                 value = "unBatchCorrectedM")

MDSinfo_uncorrected %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  # scale_color_manual(values = namedPal2)+
  scale_shape_manual(values=1:length(MDSinfo_uncorrected$Tissue))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))


# MDS_norm551.Beta or NormBMlist$MDS_norm551.Beta
table(rownames(NormBMlist$MDS_norm551.Beta$distance.matrix)==NormBMlist$phenoDataAll$Sample_name)
MDSinfo_uncorrected_beta <- ggplotMDS(MDS_norm551 = NormBMlist$MDS_norm551.Beta, 
                                      GEO_phenotypes_norm551 = NormBMlist$phenoDataAll, 
                                      value = "unBatchCorrectedBeta")

MDSinfo_uncorrected_beta %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  # scale_color_manual(values = namedPal2)+
  scale_shape_manual(values=1:length(MDSinfo_uncorrected_beta$Tissue))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))


# save plots
tiff(file = "/home/qianhui/DNAme/Process_decidual/figures/allSamplesMDS551_notCorrected.tiff",
    width = 20, height = 12, units = "cm", res = 300)
theme_set(theme_bw())
MDSinfo_uncorrected %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  # scale_color_manual(values = namedPal2)+
  scale_shape_manual(values=1:length(MDSinfo_uncorrected$Tissue))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))
dev.off()

pdf(file = "/home/qianhui/DNAme/Process_decidual/figures/allSamplesMDS551_notCorrected.pdf", 
    width = 13, height = 7)
theme_set(theme_bw())
MDSinfo_uncorrected %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  # scale_color_manual(values = namedPal2)+
  scale_shape_manual(values=1:length(MDSinfo_uncorrected$Tissue))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))
dev.off()


```


## B) Use `quantro` to look at global differences between tissue types (all 551 samples)

```{r}

qtest <- quantro(object = NormBMlist$NormBAll[,NormBMlist$phenoDataAll$Sample%in%c("Placenta","Amnion")], 
                 groupFactor = NormBMlist$phenoDataAll[NormBMlist$phenoDataAll$Sample%in%c("Placenta","Amnion"), ]$Sample)
qtest
# check difference between outliers and other placenta samples
pd_placenta <- NormBMlist$phenoDataAll[NormBMlist$phenoDataAll$Sample%in%c("Placenta"), ]
Outlier <- factor(ifelse(pd_placenta$Additional_Info%in%"Outlier", "Outlier", "Standard"))

qtest_outlier <- quantro(object = NormBMlist$NormBAll[,NormBMlist$phenoDataAll$Sample%in%"Placenta"], 
                 groupFactor = Outlier)

qtest_outlier
anova(qtest_outlier)
```
Note: we can see from the quantroStat value (40.0351) from `qtest` that difference between tissue types were larger than difference within groups.


## B) No batch corrected: MDS plot for 1st trimester samples and term samples
```{r}

# check sample (551 samples) order first
table(colnames(NormBMlist$NormBAll)==NormBMlist$phenoDataAll$Sample_name)
table(colnames(NormBMlist$NormMAll)==NormBMlist$phenoDataAll$Sample_name)

# subset 1st and term samples
Sample_1st <- NormBMlist$phenoDataAll[NormBMlist$phenoDataAll$Trimester%in%"First",]
Sample_term <- NormBMlist$phenoDataAll[NormBMlist$phenoDataAll$Trimester%in%"Term",]
# subset 1st and term Beta values
NormBAll_1st <- NormBMlist$NormBAll[, colnames(NormBMlist$NormBAll)%in%Sample_1st$Sample_name]
NormBAll_Term <- NormBMlist$NormBAll[, colnames(NormBMlist$NormBAll)%in%Sample_term$Sample_name]
# subset 1st and term M values
NormMAll_1st <- NormBMlist$NormMAll[, colnames(NormBMlist$NormMAll)%in%Sample_1st$Sample_name]
NormMAll_Term <- NormBMlist$NormMAll[, colnames(NormBMlist$NormMAll)%in%Sample_term$Sample_name]

# plot MDS for 1st and term separatly
## 1st trimester Beta
MDS_NormBAll_1st <- plotMDS(NormBAll_1st, top=nrow(NormBAll_1st), 
                         labels = Sample_1st$Sample,
                         gene.selection = "common")

MDSinfo_NormBAll_1st <- ggplotMDS(MDS_norm551 = MDS_NormBAll_1st, 
                               GEO_phenotypes_norm551 = Sample_1st, 
                               value = "MDS_B_T1_samples")

### use MDS info. and plot with ggplot
MDSinfo_NormBAll_1st %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  scale_shape_manual(values=1:length(MDSinfo_NormBAll_1st$Tissue))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))

## Term Beta
MDS_NormBAll_term <- plotMDS(NormBAll_Term, top=nrow(NormBAll_Term), 
                         labels = Sample_term$Sample,
                         gene.selection = "common")

MDSinfo_NormBAll_term <- ggplotMDS(MDS_norm551 = MDS_NormBAll_term, 
                                   GEO_phenotypes_norm551 = Sample_term, 
                                   value = "MDS_B_term_samples")
### use MDS info. and plot with ggplot
MDSinfo_NormBAll_term %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  scale_shape_manual(values=1:length(MDSinfo_NormBAll_term$Tissue))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))


## 1st trimester M
MDS_NormMAll_1st <- plotMDS(NormMAll_1st, top=nrow(NormMAll_1st), 
                         labels = Sample_1st$Sample,
                         gene.selection = "common")

MDSinfo_NormMAll_1st <- ggplotMDS(MDS_norm551 = MDS_NormMAll_1st, 
                               GEO_phenotypes_norm551 = Sample_1st, 
                               value = "MDS_M_T1_samples")
### use MDS info. and plot with ggplot
MDSinfo_NormMAll_1st %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  scale_shape_manual(values=1:length(MDSinfo_NormMAll_1st$Tissue))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))

## Term M
MDS_NormMAll_term <- plotMDS(NormMAll_Term, top=nrow(NormMAll_Term), 
                         labels = Sample_term$Sample,
                         gene.selection = "common")

MDSinfo_NormMAll_term <- ggplotMDS(MDS_norm551 = MDS_NormMAll_term, 
                                   GEO_phenotypes_norm551 = Sample_term, 
                                   value = "MDS_M_term_samples")
### use MDS info. and plot with ggplot
MDSinfo_NormMAll_term %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  scale_shape_manual(values=1:length(MDSinfo_NormMAll_term$Tissue))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))


```


## C) correct for batch, 1st and term samples

Note: we can't use combat to correct for batch (for the 1st and term samples), because at least one covariate is confounded with batch! So we need to use sva to regress out batches.
```{r}

# CombatFun2
CombatFUN2 <- function(MMat, phenotype, trimester){

  registerDoParallel(cores = 10)
  
  phenotype_matched <- phenotype[match(colnames(MMat), phenotype$Sample_name),]
  phenotype_matched$Outlier <- factor(ifelse(phenotype_matched$Additional_Info%in%"Outlier", "Outlier", "Standard"))

  if(trimester=="First"){
  TissueTypes <- c("Placenta", "Decidua",
                # "placental mesenchyme", 
                "Maternal whole blood"
                # "placental trophoblast"
                )}
  
  if(trimester=="Term"){
  TissueTypes <- c("Placenta", "Amnion", "Chorion", "Decidua", "Umbilical cord blood")
  }
  
  ListToJoin <- list()

    for(i in TissueTypes){
    # subset MMat
    MMat_i <- MMat[, phenotype_matched$Sample%in%i, drop=FALSE]
    # subset phenotype_matched
    phenotype_matched_i <- phenotype_matched[phenotype_matched$Sample%in%i, , drop=FALSE]
    
    # use combat to correct batches
     if(ncol(MMat_i)>1 & length(unique(phenotype_matched_i$Study))>1){
       
       if(length(unique(phenotype_matched_i$Outlier))>1){
         batch <- factor(phenotype_matched_i$Study)
         Outlier <- factor(phenotype_matched_i$Outlier)
         modcombat <- model.matrix(~Outlier, data = phenotype_matched_i)

         MMat_batchCorrected_i <- ComBat(dat = MMat_i,
                                         batch = batch, mod = modcombat, par.prior = TRUE, prior.plots=FALSE)
       }else{
         batch <- factor(phenotype_matched_i$Study)
         modcombat <- model.matrix(~1, data = phenotype_matched_i)

         MMat_batchCorrected_i <- ComBat(dat = MMat_i,
                                         batch = batch, mod = modcombat, par.prior = TRUE, prior.plots=FALSE)
       }
       
     }else{
       MMat_batchCorrected_i <- MMat_i
     } # end if
    
    ListToJoin[[i]] <- MMat_batchCorrected_i %>% as.data.frame() %>% rownames_to_column(var="Probe")
    
    } # end for
  
  # left_join values, to join all samples
  Join_allM_NormCombat.df <- ListToJoin %>% purrr::reduce(left_join, by = "Probe")

  # omit na values
  Join_allM_NormCombat.df_v1 <- na.omit(Join_allM_NormCombat.df)

  # as matrix
  Join_allM_NormCombat.df_v2 <- Join_allM_NormCombat.df_v1 %>% remove_rownames() %>%
  column_to_rownames(var="Probe") %>% as.matrix() 
  
  # return list containing beta and M values
  ## calculate Beta values
  BetaMat_batchCorrected <- 2^Join_allM_NormCombat.df_v2 / (1+2^Join_allM_NormCombat.df_v2)

  # return beta and M values
  phenotype_matched2 <- phenotype[match(colnames(BetaMat_batchCorrected), phenotype$Sample_name),]
  
  Combat_BM_List <- list(Beta = BetaMat_batchCorrected,
                         M = Join_allM_NormCombat.df_v2,
                         PhenoData=phenotype_matched2)
  return(Combat_BM_List)
}


# # Combat correct for batch, use `CombatFUN2`
BM_T1_combat <- CombatFUN2(MMat = NormMAll_1st,
                          phenotype = Sample_1st, 
                          trimester = "First")

BM_Term_combat <- CombatFUN2(MMat = NormMAll_Term,
                          phenotype = Sample_term, 
                          trimester = "Term")
save(BM_T1_combat, BM_Term_combat, file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/BM_T1Term_CombatCorrected.rds")

# plot MDS for Combat ajusted data: T1 and term
# plot combat Correct_T1_M
MDS_T1_combat <- plotMDS(BM_T1_combat$M, top=nrow(BM_T1_combat$M), 
              labels = BM_T1_combat$PhenoData$Sample, gene.selection = "common")

MDSinfoT1_combat <- ggplotMDS(MDS_norm551 = MDS_T1_combat, 
                    GEO_phenotypes_norm551 = Sample_1st, 
                    value = "T1_M_CombatremoveBatchEffect")

tiff(file = "/home/qianhui/DNAme/Process_decidual/figures/T1SamplesMDS_CombatCorrected.tiff",
    width = 20, height = 12, units = "cm", res = 300)
theme_set(theme_bw())
MDSinfoT1_combat %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  # scale_color_manual(values = namedPal2)+
  scale_shape_manual(values=1:length(MDSinfoT1_combat$Tissue))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))
dev.off()


# plot Combat Correct_Term_M
Outlier <- factor(ifelse(BM_Term_combat$PhenoData$Additional_Info%in%"Outlier", "Outlier", "Standard"))

MDS_Term_combat <- plotMDS(BM_Term_combat$M, top=nrow(BM_Term_combat$M), 
                           labels = Outlier, gene.selection = "common")

MDSinfoTerm_combat <- ggplotMDS(MDS_norm551 = MDS_Term_combat, 
                    GEO_phenotypes_norm551 = BM_Term_combat$PhenoData, 
                    value = "Term_M_removeBatchEffect")

tiff(file = "/home/qianhui/DNAme/Process_decidual/figures/TermSamplesMDS_CombatCorrected.tiff",
    width = 20, height = 12, units = "cm", res = 300)
theme_set(theme_bw())
MDSinfoTerm_combat %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  scale_color_manual(values = "#00BFC4")+
  scale_shape_manual(values=1:length(MDSinfoTerm_combat$Tissue))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))
dev.off()




# use sva to regress out batches

svaFUN <- function(SamplePheno, NormM){
  
# factors to consider
Sample <- as.factor(SamplePheno$Sample)
Trimester <- as.factor(SamplePheno$Trimester)
batch <- factor(SamplePheno$Study)

# M values
mval <- NormM

# factor that interested
mod <- model.matrix(~Sample, data = SamplePheno)

# adjustment variables
mod0 <- model.matrix(~1, data = SamplePheno)
sva_M <- sva(mval, mod, mod0)

summary(aov(sva_M$sv ~ batch)) %>% print()

# use removeBetachEffect
design = model.matrix( ~ Sample, data= SamplePheno)
y <- removeBatchEffect(mval, 
                       # batch = NormBMlist$phenoDataAll$Study,
                       # batch2 = NormBMlist$phenoDataAll$ArrayType,
                       # covariates = NormBMlist$phenoDataAl$ControlPC1,
                       covariates = sva_M$sv[,1:3],
                       design=design)

return(list(sva_M=sva_M, mval_sv1Removed=y))

}

svaCorrect_T1_M <- svaFUN(SamplePheno = Sample_1st, NormM = NormMAll_1st)

svaCorrect_Term_M <- svaFUN(SamplePheno = Sample_term, NormM = NormMAll_Term)

save(svaCorrect_T1_M, svaCorrect_Term_M, file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/svaCorrect_T1Term_M_CombatCorrected.rds")

# plot svaCorrect_T1_M
MDS_T1 <- plotMDS(svaCorrect_T1_M$mval_sv1Removed, top=nrow(svaCorrect_T1_M$mval_sv1Removed), 
              labels = Sample_1st$Sample, gene.selection = "common")

MDSinfoT1 <- ggplotMDS(MDS_norm551 = MDS_T1, 
                    GEO_phenotypes_norm551 = Sample_1st, 
                    value = "T1_M_removeBatchEffect")


MDSinfoT1 %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  # scale_color_manual(values = namedPal2)+
  scale_shape_manual(values=1:length(MDSinfoT1$Tissue))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))

# plot svaCorrect_Term_M
MDS_Term <- plotMDS(svaCorrect_Term_M$mval_sv1Removed, top=nrow(svaCorrect_Term_M$mval_sv1Removed), 
              labels = Sample_term$Sample, gene.selection = "common")

MDSinfoTerm <- ggplotMDS(MDS_norm551 = MDS_Term, 
                    GEO_phenotypes_norm551 = Sample_term, 
                    value = "Term_M_removeBatchEffect")

MDSinfoTerm %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  # scale_color_manual(values = namedPal2)+
  scale_shape_manual(values=1:length(MDSinfoTerm$Tissue))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))

```



# 6. regress out batch estimated from control probes (whole data set, 551 smaples)

## plot batch corrected data (batch estimated based on control probes)
```{r}

# load the data of control probes
# Control551_Beta, Control551_M
load(file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/Controls_BM_all551.RData")

## Response MDS$x varies with control PC1:
table(NormBMlist$phenoDataAll$Sample_name==rownames(Control551_M$PCA_control$ind$coord))
table(colnames(NormBMlist$NormMAll)==rownames(Control551_M$PCA_control$ind$coord))
cor.test(NormBMlist$MDS_norm551.M$x, Control551_M$PCA_control$ind$coord[,1])

## Fit model:
NormBMlist$phenoDataAll$ControlPC1 <- Control551_M$PCA_control$ind$coord[,1]
NormBMlist$phenoDataAll$ControlPC2 <- Control551_M$PCA_control$ind$coord[,2]
# NormBMlist$phenoDataAll$ControlPC3 <- Control551_M$PCA_control$ind$coord[,3]

design1 <- model.matrix(~ControlPC1+ControlPC2, data= NormBMlist$phenoDataAll) #ControlPC1+ControlPC2

## fit lm using limma: 
fit1_limma <- lmFit(NormBMlist$NormMAll, design = design1)
fit2_limma_eBayesAdjusted <- eBayes(fit1_limma)

Residuals <- residuals.MArrayLM(fit2_limma_eBayesAdjusted, NormBMlist$NormMAll)

MDS_residuals <- plotMDS(Residuals, top=nrow(Residuals), 
                         labels = NormBMlist$phenoDataAll$Sample, gene.selection = "common")

MDSinfo_residuals <- ggplotMDS(MDS_norm551 = MDS_residuals, 
                               GEO_phenotypes_norm551 = NormBMlist$phenoDataAll, 
                               value = "MDS_residuals")

save(Residuals, file = "/home/qianhui/DNAme/Process_decidual/RDSfiles/allSamplesResiduals_ControlCorrected_residuals.rds")

## plot MDS with ggplot
MDSinfo_residuals %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  # scale_color_manual(values = namedPal2)+
  scale_shape_manual(values=1:length(MDSinfo_residuals$Tissue))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))




## use `removeBatchEffect`
Sample <- as.factor(NormBMlist$phenoDataAll$Sample)
Trimester <- as.factor(NormBMlist$phenoDataAll$Trimester)
design = model.matrix( ~ Sample+Trimester, data= NormBMlist$phenoDataAll)
y <- removeBatchEffect(NormBMlist$NormMAll, 
                       # batch = NormBMlist$phenoDataAll$Study,
                       # batch2 = NormBMlist$phenoDataAll$ArrayType,
                       # covariates = NormBMlist$phenoDataAl$ControlPC1,
                       covariates = Control551_M$PCA_control$ind$coord[,1:2],
                       design=design)

MDS<- plotMDS(y, top=nrow(y), labels = NormBMlist$phenoDataAll$Sample, gene.selection = "common")
MDSinfo <- ggplotMDS(MDS_norm551 = MDS, 
                    GEO_phenotypes_norm551 = NormBMlist$phenoDataAll, 
                    value = "M_removeBatchEffect")

MDSinfo %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  # scale_color_manual(values = namedPal2)+
  scale_shape_manual(values=1:length(MDSinfo$Tissue))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))

## Now residuals are not correlated with age:
# cor.test(lm1$residuals, dat$age)

## Residuals vs original
# plot(lm1$residuals, dat$y)
## ... Now use lm1$residuals instead of dat$y

# save plots
tiff(file = "/home/qianhui/DNAme/Process_decidual/figures/allSamplesMDS551_controlProbeCorrected.tiff",
    width = 20, height = 12, units = "cm", res = 300)
theme_set(theme_bw())
MDSinfo_residuals %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  # scale_color_manual(values = namedPal2)+
  scale_shape_manual(values=1:length(MDSinfo_residuals$Tissue))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))
dev.off()

pdf(file = "/home/qianhui/DNAme/Process_decidual/figures/allSamplesMDS551_controlProbeCorrected.pdf", 
    width = 13, height = 7)
theme_set(theme_bw())
MDSinfo_residuals %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  # scale_color_manual(values = namedPal2)+
  scale_shape_manual(values=1:length(MDSinfo_residuals$Tissue))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))
dev.off()

```


## plot batch corrected data (only 1st and term samples)
```{r}

# 1st trimester & term samples
MDSinfo_residuals_First <- MDSinfo_residuals[MDSinfo_residuals$Trimester%in%"First",]
MDSinfo_residuals_Term <- MDSinfo_residuals[MDSinfo_residuals$Trimester%in%"Term",]


tiff(file = "/home/qianhui/DNAme/Process_decidual/figures/T1SamplesMDS_controlProbeCorrected.tiff",
    width = 20, height = 12, units = "cm", res = 300)
theme_set(theme_bw())
MDSinfo_residuals_First %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  # scale_color_manual(values = namedPal2)+
  scale_shape_manual(values=3:7)+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))
dev.off()


tiff(file = "/home/qianhui/DNAme/Process_decidual/figures/TermSamplesMDS_controlProbeCorrected.tiff",
    width = 20, height = 12, units = "cm", res = 300)
theme_set(theme_bw())
MDSinfo_residuals_Term %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  scale_color_manual(values = "#00BFC4")+
  scale_shape_manual(values=c(1:3,5,9))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))
dev.off()

```


<!-- # 6. Use RUVrinv to remove batches/unwatned variables -->
<!-- ```{r} -->
<!-- library(missMethyl) -->
<!-- library(ruv) -->

<!-- # RUVrinv for test unwanted variation based on small negtive control -->

<!-- ## first, add Illumina negtive controls probes information -->

<!-- mod <- model.matrix(~ Sample+Trimester, data = NormBMlist$phenoDataAll) -->

<!-- # INCs are Illumina negtive controls -->
<!-- # INCs <- getINCs(EPIC_RG_Placenta) -->
<!-- INCs <- Control551_M$JoinAllControl -->

<!-- # Mc means combine m-value and Illumina negtive controls -->
<!-- Mc <- base::rbind(NormBMlist$NormMAll, INCs) -->
<!-- tMc <- t(Mc) -->
<!-- # ctl means ctl probes' information, NB: ctl need to be a logical vector -->
<!-- ctl <- base::colnames(tMc) %in% base::rownames(INCs) -->

<!-- table(ctl) -->


<!-- ### fit RUVrinv -->

<!-- # X is the interest variable, so set X as: X <- as.matrix(design[, coef]) -->
<!-- # Z is covariables, so set Z as: Z <- as.matrix(design[, -coef]) -->

<!-- fit.RUVrinv <- RUVrinv(Y = tMc, X = as.matrix(mod[,5]), ctl = ctl, Z = as.matrix(mod[, -2])) -->

<!-- fit2.RUVrinv <- variance_adjust(fit.RUVrinv) -->

<!-- #saveRDS(fit2.RUVrinv, file = "/home/qianhui/DNAme/Process-QH/Placenta5-fit2.RUVrinv.rds") -->

<!-- table(fit2.RUVrinv$p.ebayes.BH<0.01) -->

<!-- summary(lm(fit2.RUVrinv$W ~ phenoDataPlacenta$Batch)) -->

<!-- ``` -->


# 7. SVA to remove batch (whole data set, 551 smaples)
```{r}

# factors to consider
Sample <- as.factor(NormBMlist$phenoDataAll$Sample)
Trimester <- as.factor(NormBMlist$phenoDataAll$Trimester)
batch <- factor(NormBMlist$phenoDataAll$Study)

# M values
mval <- NormBMlist$NormMAll

# factor that interested
mod <- model.matrix(~Sample+Trimester, data = NormBMlist$phenoDataAll)

# adjustment variables
mod0 <- model.matrix(~1, data = NormBMlist$phenoDataAll)
sva_M <- sva(mval, mod, mod0)

summary(aov(sva_M$sv ~ batch))

# use removeBetachEffect

design = model.matrix( ~ Sample+Trimester, data= NormBMlist$phenoDataAll)
y <- removeBatchEffect(NormBMlist$NormMAll, 
                       # batch = NormBMlist$phenoDataAll$Study,
                       # batch2 = NormBMlist$phenoDataAll$ArrayType,
                       # covariates = NormBMlist$phenoDataAl$ControlPC1,
                       covariates = sva_M$sv[,1],
                       design=design)

MDS<- plotMDS(y, top=nrow(y), labels = NormBMlist$phenoDataAll$Sample, gene.selection = "common")
MDSinfo <- ggplotMDS(MDS_norm551 = MDS, 
                    GEO_phenotypes_norm551 = NormBMlist$phenoDataAll, 
                    value = "M_removeBatchEffect")

MDSinfo %>%
  ggplot(aes(x, y)) + 
  geom_point(aes(shape = Tissue, col=Trimester), alpha = 1, size = 5)+ 
  # scale_color_manual(values = namedPal2)+
  scale_shape_manual(values=1:length(MDSinfo$Tissue))+
  labs(x="Dimension 1", y="Dimension 2")+
  theme(text = element_text(size=15))


```

